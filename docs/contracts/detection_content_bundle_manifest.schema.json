{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Detection content bundle manifest",
  "description": "Manifest for a Detection Content Release bundle (ruleset snapshot + mapping pack snapshot(s) + optional criteria pack snapshots).",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "contract_version",
    "schema_version",
    "content_bundle_id",
    "content_bundle_version",
    "created_at",
    "profile",
    "components",
    "integrity"
  ],
  "properties": {
    "contract_version": {
      "const": "0.1.0"
    },
    "schema_version": {
      "const": "pa:detection_content_bundle_manifest:v1"
    },
    "content_bundle_id": {
      "$ref": "#/$defs/id_slug_v1"
    },
    "content_bundle_version": {
      "$ref": "#/$defs/semver_v1"
    },
    "created_at": {
      "$ref": "#/$defs/rfc3339_utc_z"
    },
    "profile": {
      "const": "detection_content_release_v1"
    },
    "description": {
      "type": "string",
      "maxLength": 4096
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "maxLength": 64
      },
      "uniqueItems": true
    },
    "changelog_path": {
      "$ref": "#/$defs/relpath_v1"
    },
    "components": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "rule_sets",
        "mapping_packs"
      ],
      "properties": {
        "rule_sets": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/rule_set_component"
          }
        },
        "mapping_packs": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/mapping_pack_component"
          }
        },
        "criteria_packs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/criteria_pack_component"
          }
        }
      }
    },
    "integrity": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "checksums_path",
        "package_tree_sha256"
      ],
      "properties": {
        "checksums_path": {
          "const": "security/checksums.txt"
        },
        "package_tree_sha256": {
          "$ref": "#/$defs/sha256_digest_string"
        }
      }
    },
    "build": {
      "type": "object",
      "additionalProperties": true,
      "description": "Optional build metadata (e.g., source control reference, build system version)."
    }
  },
  "$defs": {
    "id_slug_v1": {
      "type": "string",
      "description": "Lowercase alphanumeric with hyphens; must not start/end with hyphen; must not contain '--'.",
      "pattern": "^(?!.*--)[a-z0-9](?:[a-z0-9-]{0,62}[a-z0-9])?$"
    },
    "semver_v1": {
      "type": "string",
      "description": "SemVer 2.0.0 string.",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z.-]+)?(?:\\+[0-9A-Za-z.-]+)?$"
    },
    "rfc3339_utc_z": {
      "type": "string",
      "description": "UTC RFC 3339 timestamp ending in 'Z'.",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(?:\\.\\d{1,9})?Z$"
    },
    "sha256_digest_string": {
      "type": "string",
      "description": "Digest string in the form 'sha256:<lowercase_hex>'.",
      "pattern": "^sha256:[0-9a-f]{64}$"
    },
    "relpath_v1": {
      "type": "string",
      "description": "Bundle-root-relative POSIX path (no leading '/', no backslashes, no '..').",
      "pattern": "^(?!/)(?!.*\\\\)(?!.*(?:^|/)\\.\\.(?:/|$))(?!.*//)[A-Za-z0-9._-]+(?:/[A-Za-z0-9._-]+)*$"
    },
    "rule_set_component": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "rule_set_id",
        "rule_set_version",
        "root_path"
      ],
      "properties": {
        "rule_set_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "rule_set_version": {
          "$ref": "#/$defs/semver_v1"
        },
        "root_path": {
          "$ref": "#/$defs/relpath_v1"
        },
        "rule_count": {
          "type": "integer",
          "minimum": 0
        },
        "notes": {
          "type": "string",
          "maxLength": 4096
        }
      }
    },
    "mapping_pack_component": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mapping_pack_id",
        "mapping_pack_version",
        "snapshot_path",
        "mapping_pack_sha256"
      ],
      "properties": {
        "mapping_pack_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "mapping_pack_version": {
          "$ref": "#/$defs/semver_v1"
        },
        "snapshot_path": {
          "$ref": "#/$defs/relpath_v1"
        },
        "mapping_pack_sha256": {
          "$ref": "#/$defs/sha256_digest_string"
        }
      }
    },
    "criteria_pack_component": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "criteria_pack_id",
        "criteria_pack_version",
        "manifest_path",
        "criteria_path",
        "pack_sha256"
      ],
      "properties": {
        "criteria_pack_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "criteria_pack_version": {
          "$ref": "#/$defs/semver_v1"
        },
        "manifest_path": {
          "$ref": "#/$defs/relpath_v1"
        },
        "criteria_path": {
          "$ref": "#/$defs/relpath_v1"
        },
        "pack_sha256": {
          "$ref": "#/$defs/sha256_digest_string"
        }
      }
    }
  }
}