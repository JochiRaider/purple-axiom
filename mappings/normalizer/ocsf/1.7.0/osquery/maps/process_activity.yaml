map_id: osquery-process-activity
map_version: 0.1.0
source_type: osquery
ocsf_version: "1.7.0"

route_match:
  query_name: process_events

target:
  class_uid: 1007 # Process Activity

# activity_id mapping (explicit; unknown rather than guessed)
activity:
  selector: action
  transforms: [trim, lowercase]
  mapping:
    added: 1     # Launch (aligned to Windows Security mapping usage)
    removed: 2   # Terminate
    snapshot: 0  # Unknown (state snapshot, not an event)
  default: 0

type_uid:
  formula: "class_uid * 100 + activity_id"

# Base provenance and shared fields
fields:
  - target: metadata.product.name
    value: osquery

  - target: metadata.source_type
    value: osquery

  - target: metadata.log_name
    value: osqueryd.results.log

  # Device hostname (best-effort, deterministic; no external lookup)
  - target: device.hostname
    selector:
      coalesce: [hostIdentifier, osquery.host_identifier]
    transforms: [trim, lowercase]
    when:
      present: true

  # Actor user (if available)
  - target: actor.user.uid
    selector:
      coalesce: [columns.uid, columns.euid]
    transforms: [trim, absent_if_placeholder]
    when:
      present: true

  - target: actor.user.name
    selector:
      coalesce: [columns.username, columns.user]
    transforms: [trim, absent_if_placeholder]
    when:
      present: true

  # Process attribution (authoritative-only)
  - target: actor.process.pid
    selector: columns.pid
    transforms: [trim, parse_int_base10]
    when:
      present: true

  - target: actor.process.parent_process.pid
    selector:
      coalesce: [columns.ppid, columns.parent]
    transforms: [trim, parse_int_base10]
    when:
      present: true

  # Executable path and name (no inference from cmdline)
  - target: actor.process.file.path
    selector:
      coalesce: [columns.path, columns.exe]
    transforms: [trim, absent_if_placeholder]
    when:
      present: true

  - target: actor.process.name
    selector:
      coalesce: [columns.name, columns.path, columns.exe]
    transforms: [trim, absent_if_placeholder, path_basename]
    when:
      present: true

  # Command line (optional; redaction policy must be applied upstream)
  - target: actor.process.cmd_line
    selector: columns.cmdline
    transforms: [trim, absent_if_placeholder]
    when:
      present: true
    constraints:
      redaction_required: true

# Unmapped preservation
unmapped:
  preserve_under: unmapped.osquery
  include:
    - name
    - action
    - unixTime
    - columns
    - snapshot
    - calendarTime
