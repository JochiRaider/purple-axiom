{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:purple-axiom:contract:cache_provenance:1.0.0",
  "title": "Purple Axiom Cache Provenance (runner evidence)",
  "description": "Records cache usage across pipeline components (runner, normalization, detection compilation) as a deterministic, redaction-safe artifact.",
  "$comment": "Deterministic ordering (normative, not machine-enforced by JSON Schema): entries[] MUST be sorted by (component, cache_name, key) ascending (UTF-8 byte order). Keys and notes MUST NOT contain secrets.",
  "type": "object",
  "additionalProperties": false,
  "required": ["contract_version", "run_id", "generated_at_utc", "entries"],
  "properties": {
    "contract_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Contract version for this artifact schema."
    },
    "run_id": {
      "type": "string",
      "description": "Run identifier (RFC 4122 UUID, canonical lowercase).",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "generated_at_utc": {
      "type": "string",
      "description": "UTC timestamp when this artifact was generated.",
      "format": "date-time"
    },
    "entries": {
      "type": "array",
      "description": "Cache usage entries. Deterministic ordering required: sort by (component, cache_name, key) ascending (UTF-8 byte order).",
      "items": { "$ref": "#/$defs/cache_entry" }
    }
  },
  "$defs": {
    "lower_token": {
      "type": "string",
      "description": "Lowercase token suitable for deterministic logs and filenames.",
      "pattern": "^[a-z][a-z0-9_]{0,63}$"
    },
    "sha256_key": {
      "type": "string",
      "description": "Redaction-safe cache key. RECOMMENDED (and expected for v0.1 determinism): sha256:<64 lowercase hex>.",
      "pattern": "^sha256:[0-9a-f]{64}$"
    },
    "cache_policy": {
      "type": "string",
      "enum": ["disabled", "per_run_only", "cross_run_allowed"],
      "description": "Effective cache policy for this cache instance."
    },
    "cache_result": {
      "type": "string",
      "enum": ["hit", "miss", "bypassed"],
      "description": "Observed cache result for the given key."
    },
    "cache_entry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["component", "cache_name", "policy", "key", "result"],
      "properties": {
        "component": {
          "$ref": "#/$defs/lower_token",
          "description": "Component that used the cache (example: runner, normalization, detection)."
        },
        "cache_name": {
          "$ref": "#/$defs/lower_token",
          "description": "Stable cache name within the component (example: sigma_compile_cache)."
        },
        "policy": { "$ref": "#/$defs/cache_policy" },
        "key": {
          "$ref": "#/$defs/sha256_key",
          "description": "Redaction-safe cache key. MUST NOT contain secrets."
        },
        "result": { "$ref": "#/$defs/cache_result" },
        "notes": {
          "type": "string",
          "description": "Optional redaction-safe note. MUST NOT contain secrets.",
          "maxLength": 1024
        }
      }
    }
  }
}
