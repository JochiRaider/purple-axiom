# Network Activity (class_uid 4001) mappings for Sysmon
schema_version: "pa.class_map.v0.1"
ocsf_version: "1.7.0"
source_type: "windows-sysmon"
class_uid: 4001

shared:
  device:
    - path: "device.name"
      from: ["$.computer"]
      transforms: ["trim"]
      emit_if_present: true
    - path: "device.hostname"
      from: ["$.computer"]
      transforms: ["trim", "hostname_lower"]
      emit_if_present: true

  metadata:
    - path: "metadata.product.name"
      value: "sysmon"
    - path: "metadata.log_provider"
      value: "Microsoft-Windows-Sysmon"
    - path: "metadata.log_name"
      value: "Microsoft-Windows-Sysmon/Operational"
    - path: "metadata.source_event_id"
      from: ["$.record_id"]
      transforms: ["trim"]
      emit_if_present: true

  actor_user_from_eventdata_user:
    source: "$.event_data.User"
    transform: "parse_domain_user"

entries:
  # Sysmon Event ID 3: Network connection (activity_id 1)
  sysmon_eid_3:
    selectors:
      event_id: 3
    ocsf:
      activity_id: 1
    fields:
      - path: "actor.user.name"
        from_object:
          ref: "actor_user_from_eventdata_user"
          key: "name"
        emit_if_present: true
      - path: "actor.user.domain"
        from_object:
          ref: "actor_user_from_eventdata_user"
          key: "domain"
        emit_if_present: true

      # Initiating process (Sysmon provides Image/ProcessId/ProcessGuid)
      - path: "actor.process.pid"
        from: ["$.event_data.ProcessId"]
        transforms: ["parse_int"]
        emit_if_present: true
      - path: "actor.process.uid"
        from: ["$.event_data.ProcessGuid"]
        transforms: ["trim"]
        emit_if_present: true
      - path: "actor.process.file.path"
        from: ["$.event_data.Image"]
        transforms: ["trim"]
        emit_if_present: true

      # Source/Destination endpoints
      - path: "src_endpoint.ip"
        from: ["$.event_data.SourceIp"]
        transforms: ["trim"]
        emit_if_present: true
      - path: "src_endpoint.port"
        from: ["$.event_data.SourcePort"]
        transforms: ["parse_int"]
        emit_if_present: true

      - path: "dst_endpoint.ip"
        from: ["$.event_data.DestinationIp"]
        transforms: ["trim"]
        emit_if_present: true
      - path: "dst_endpoint.port"
        from: ["$.event_data.DestinationPort"]
        transforms: ["parse_int"]
        emit_if_present: true
      - path: "dst_endpoint.hostname"
        from: ["$.event_data.DestinationHostname"]
        transforms: ["trim"]
        emit_if_present: true

      # Protocol: v0.1 preserves raw string without inferring numeric protocol.
      - path: "extensions.purple.sysmon.protocol"
        from: ["$.event_data.Protocol"]
        transforms: ["trim"]
        emit_if_present: true
