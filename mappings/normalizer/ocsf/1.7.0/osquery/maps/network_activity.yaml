map_id: osquery-network-activity
map_version: 0.1.0
source_type: osquery
ocsf_version: "1.7.0"

route_match:
  query_name: socket_events

target:
  class_uid: 4001 # Network Activity

activity:
  selector: action
  transforms: [trim, lowercase]
  mapping:
    added: 1     # Connect (semantic placeholder; keep stable)
    removed: 2   # Disconnect
    snapshot: 0
  default: 0

type_uid:
  formula: "class_uid * 100 + activity_id"

fields:
  - target: metadata.product.name
    value: osquery

  - target: metadata.source_type
    value: osquery

  - target: metadata.log_name
    value: osqueryd.results.log

  - target: device.hostname
    selector:
      coalesce: [hostIdentifier, osquery.host_identifier]
    transforms: [trim, lowercase]
    when:
      present: true

  # Endpoints: local == src, remote == dst (normative for this profile)
  - target: src_endpoint.ip
    selector:
      coalesce: [columns.local_address, columns.local_addr]
    transforms: [trim, absent_if_placeholder, normalize_ip]
    when:
      present: true

  - target: src_endpoint.port
    selector:
      coalesce: [columns.local_port, columns.local_p]
    transforms: [trim, normalize_port_int]
    when:
      present: true

  - target: dst_endpoint.ip
    selector:
      coalesce: [columns.remote_address, columns.remote_addr]
    transforms: [trim, absent_if_placeholder, normalize_ip]
    when:
      present: true

  - target: dst_endpoint.port
    selector:
      coalesce: [columns.remote_port, columns.remote_p]
    transforms: [trim, normalize_port_int]
    when:
      present: true

  # Process attribution (authoritative-only)
  - target: actor.process.pid
    selector: columns.pid
    transforms: [trim, parse_int_base10]
    when:
      present: true

  - target: actor.process.file.path
    selector:
      coalesce: [columns.path, columns.exe]
    transforms: [trim, absent_if_placeholder]
    when:
      present: true

  - target: actor.process.name
    selector:
      coalesce: [columns.name, columns.path, columns.exe]
    transforms: [trim, absent_if_placeholder, path_basename]
    when:
      present: true

unmapped:
  preserve_under: unmapped.osquery
  include:
    - name
    - action
    - unixTime
    - columns
    - snapshot
    - calendarTime
