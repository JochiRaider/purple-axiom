{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "range_config.schema.json",
  "title": "Purple Axiom range configuration (range.yaml)",
  "description": "JSON Schema for the Purple Axiom range configuration file (range.yaml).",
  "$comment": "contract_id=range_config; contract_version=0.1.0",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "contract_version": {
      "type": "string",
      "const": "0.1.0"
    },
    "lab": {
      "$ref": "#/$defs/lab"
    },
    "runner": {
      "$ref": "#/$defs/runner"
    },
    "cache": {
      "$ref": "#/$defs/cache"
    },
    "control_plane": {
      "$ref": "#/$defs/control_plane"
    },
    "telemetry": {
      "$ref": "#/$defs/telemetry"
    },
    "normalization": {
      "$ref": "#/$defs/normalization"
    },
    "validation": {
      "$ref": "#/$defs/validation"
    },
    "detection": {
      "$ref": "#/$defs/detection"
    },
    "scoring": {
      "$ref": "#/$defs/scoring"
    },
    "reporting": {
      "$ref": "#/$defs/reporting"
    },
    "operability": {
      "$ref": "#/$defs/operability"
    },
    "security": {
      "$ref": "#/$defs/security"
    },
    "extensions": {
      "$ref": "#/$defs/extensions"
    }
  },
  "required": [
    "lab",
    "runner",
    "normalization",
    "reporting"
  ],
  "allOf": [
    {
      "if": {
        "properties": {
          "security": {
            "properties": {
              "secrets": {
                "properties": {
                  "provider": {
                    "const": "env"
                  }
                },
                "required": [
                  "provider"
                ]
              }
            },
            "required": [
              "secrets"
            ]
          }
        },
        "required": [
          "security"
        ]
      },
      "then": {
        "properties": {
          "runner": {
            "properties": {
              "caldera": {
                "properties": {
                  "api_token_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  }
                }
              }
            }
          },
          "control_plane": {
            "properties": {
              "auth": {
                "properties": {
                  "username_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  },
                  "password_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  },
                  "private_key_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  },
                  "token_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  }
                }
              }
            }
          },
          "reporting": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  }
                }
              }
            }
          },
          "security": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  }
                }
              },
              "signing": {
                "properties": {
                  "key_ref": {
                    "$ref": "#/$defs/secret_ref_env"
                  }
                }
              },
              "secrets": {
                "properties": {
                  "refs": {
                    "$ref": "#/$defs/security_secrets_refs_env"
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "security": {
            "properties": {
              "secrets": {
                "properties": {
                  "provider": {
                    "const": "file"
                  }
                },
                "required": [
                  "provider"
                ]
              }
            },
            "required": [
              "secrets"
            ]
          }
        },
        "required": [
          "security"
        ]
      },
      "then": {
        "properties": {
          "runner": {
            "properties": {
              "caldera": {
                "properties": {
                  "api_token_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  }
                }
              }
            }
          },
          "control_plane": {
            "properties": {
              "auth": {
                "properties": {
                  "username_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  },
                  "password_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  },
                  "private_key_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  },
                  "token_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  }
                }
              }
            }
          },
          "reporting": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  }
                }
              }
            }
          },
          "security": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  }
                }
              },
              "signing": {
                "properties": {
                  "key_ref": {
                    "$ref": "#/$defs/secret_ref_file"
                  }
                }
              },
              "secrets": {
                "properties": {
                  "refs": {
                    "$ref": "#/$defs/security_secrets_refs_file"
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "security": {
            "properties": {
              "secrets": {
                "properties": {
                  "provider": {
                    "const": "keychain"
                  }
                },
                "required": [
                  "provider"
                ]
              }
            },
            "required": [
              "secrets"
            ]
          }
        },
        "required": [
          "security"
        ]
      },
      "then": {
        "properties": {
          "runner": {
            "properties": {
              "caldera": {
                "properties": {
                  "api_token_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  }
                }
              }
            }
          },
          "control_plane": {
            "properties": {
              "auth": {
                "properties": {
                  "username_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  },
                  "password_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  },
                  "private_key_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  },
                  "token_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  }
                }
              }
            }
          },
          "reporting": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  }
                }
              }
            }
          },
          "security": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  }
                }
              },
              "signing": {
                "properties": {
                  "key_ref": {
                    "$ref": "#/$defs/secret_ref_keychain"
                  }
                }
              },
              "secrets": {
                "properties": {
                  "refs": {
                    "$ref": "#/$defs/security_secrets_refs_keychain"
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "security": {
            "properties": {
              "secrets": {
                "properties": {
                  "provider": {
                    "const": "custom"
                  }
                },
                "required": [
                  "provider"
                ]
              }
            },
            "required": [
              "secrets"
            ]
          }
        },
        "required": [
          "security"
        ]
      },
      "then": {
        "properties": {
          "runner": {
            "properties": {
              "caldera": {
                "properties": {
                  "api_token_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  }
                }
              }
            }
          },
          "control_plane": {
            "properties": {
              "auth": {
                "properties": {
                  "username_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  },
                  "password_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  },
                  "private_key_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  },
                  "token_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  }
                }
              }
            }
          },
          "reporting": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  }
                }
              }
            }
          },
          "security": {
            "properties": {
              "redaction": {
                "properties": {
                  "policy_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  }
                }
              },
              "signing": {
                "properties": {
                  "key_ref": {
                    "$ref": "#/$defs/secret_ref_custom"
                  }
                }
              },
              "secrets": {
                "properties": {
                  "refs": {
                    "$ref": "#/$defs/security_secrets_refs_custom"
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "runner": {
            "properties": {
              "identity": {
                "properties": {
                  "cache_policy": {
                    "const": "cross_run_allowed"
                  }
                },
                "required": [
                  "cache_policy"
                ]
              }
            },
            "required": [
              "identity"
            ]
          }
        },
        "required": [
          "runner"
        ]
      },
      "then": {
        "properties": {
          "cache": {
            "required": [
              "cross_run_allowed",
              "emit_cache_provenance"
            ],
            "properties": {
              "cross_run_allowed": {
                "const": true
              },
              "emit_cache_provenance": {
                "const": true
              }
            }
          }
        },
        "required": [
          "cache"
        ]
      }
    }
  ],
  "$defs": {
    "extensions": {
      "type": "object",
      "description": "Forward-compatible extension bag. Keys are implementation-defined.",
      "additionalProperties": true
    },
    "id_slug_v1": {
      "type": "string",
      "pattern": "^(?!.*--)[a-z0-9](?:[a-z0-9-]{0,62}[a-z0-9])?$",
      "description": "ID slug v1 (lowercase ASCII, hyphen-separated)."
    },
    "semver": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$",
      "description": "Semantic Versioning 2.0.0 string."
    },
    "version_token_v1": {
      "type": "string",
      "pattern": "^[A-Za-z0-9][A-Za-z0-9._:+-]{0,127}$",
      "description": "Version token v1 (no slashes/spaces); may be SemVer or implementation token."
    },
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID string (lowercase hex with hyphens)."
    },
    "sha256_hex": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$",
      "description": "Lowercase hex SHA-256 digest."
    },
    "hex64": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$",
      "description": "64 lowercase hex characters."
    },
    "attack_technique_id": {
      "type": "string",
      "pattern": "^T[0-9]{4}(?:\\.[0-9]{3})?$",
      "description": "MITRE ATT&CK technique id (e.g., T1059 or T1059.001)."
    },
    "path_any": {
      "type": "string",
      "pattern": "^[^\\r\\n]+$",
      "description": "Filesystem path (string). Newlines are disallowed."
    },
    "path_rel": {
      "type": "string",
      "pattern": "^(?!/)(?![A-Za-z]:[\\\\/])(?!\\\\\\\\\\\\\\\\)[^\\r\\n]+$",
      "description": "Relative filesystem path (must not be absolute or UNC)."
    },
    "path_abs": {
      "type": "string",
      "description": "Absolute filesystem path (Unix, Windows drive, or UNC).",
      "anyOf": [
        {
          "type": "string",
          "pattern": "^/[^\\\\0\\r\\n]+$"
        },
        {
          "type": "string",
          "pattern": "^[A-Za-z]:[\\\\/][^\\r\\n]+$"
        },
        {
          "type": "string",
          "pattern": "^\\\\\\\\\\\\\\\\[^\\r\\n]+$"
        }
      ]
    },
    "secret_ref_any": {
      "type": "string",
      "pattern": "^(env|file|keychain|custom):[^\\r\\n]+$",
      "description": "Secret reference string: <provider>:<selector>."
    },
    "secret_ref_env": {
      "type": "string",
      "pattern": "^env:[A-Za-z_][A-Za-z0-9_]*$",
      "description": "Secret reference string using env:<VAR_NAME>."
    },
    "secret_ref_file": {
      "type": "string",
      "pattern": "^file:[^\\r\\n]+$",
      "description": "Secret reference string using file:<PATH>."
    },
    "secret_ref_keychain": {
      "type": "string",
      "pattern": "^keychain:[^\\r\\n]+$",
      "description": "Secret reference string using keychain:<SELECTOR>."
    },
    "secret_ref_custom": {
      "type": "string",
      "pattern": "^custom:[^\\r\\n]+$",
      "description": "Secret reference string using custom:<REF_KEY>."
    },
    "secret_provider": {
      "type": "string",
      "enum": [
        "env",
        "file",
        "keychain",
        "custom"
      ],
      "description": "Secret reference provider selector."
    },
    "os_enum": {
      "type": "string",
      "enum": [
        "windows",
        "linux",
        "macos",
        "bsd",
        "appliance",
        "other"
      ]
    },
    "asset_role_enum": {
      "type": "string",
      "enum": [
        "endpoint",
        "server",
        "domain_controller",
        "network",
        "sensor",
        "other"
      ]
    },
    "fail_mode_enum": {
      "type": "string",
      "enum": [
        "fail_closed",
        "warn_and_skip"
      ]
    },
    "scalar": {
      "description": "Scalar YAML/JSON value (string, number, integer, boolean) used for non-secret hints.",
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "number"
        },
        {
          "type": "boolean"
        }
      ]
    },
    "map_string_to_scalar": {
      "type": "object",
      "description": "Arbitrary key/value map (values are scalars).",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,64}$": {
          "$ref": "#/$defs/scalar"
        }
      }
    },
    "lab_asset": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "asset_id",
        "os"
      ],
      "properties": {
        "asset_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "os": {
          "$ref": "#/$defs/os_enum"
        },
        "role": {
          "$ref": "#/$defs/asset_role_enum"
        },
        "hostname": {
          "type": "string",
          "minLength": 1
        },
        "ip": {
          "type": "string",
          "minLength": 1
        },
        "vars": {
          "$ref": "#/$defs/map_string_to_scalar"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "lab_inventory": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "path": {
          "$ref": "#/$defs/path_any"
        },
        "format": {
          "type": "string",
          "enum": [
            "ansible_yaml",
            "ansible_ini",
            "json"
          ]
        },
        "refresh": {
          "type": "string",
          "enum": [
            "never",
            "on_run_start"
          ]
        },
        "snapshot_to_run_bundle": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "lab_networks": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cidrs": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "notes": {
          "type": "string"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "lab": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "assets"
      ],
      "properties": {
        "provider": {
          "type": "string",
          "enum": [
            "manual",
            "ludus",
            "terraform",
            "vagrant",
            "other"
          ]
        },
        "assets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/lab_asset"
          },
          "minItems": 1
        },
        "inventory": {
          "$ref": "#/$defs/lab_inventory"
        },
        "networks": {
          "$ref": "#/$defs/lab_networks"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "anyOf": [
              {
                "not": {
                  "required": [
                    "provider"
                  ]
                }
              },
              {
                "properties": {
                  "provider": {
                    "const": "manual"
                  }
                },
                "required": [
                  "provider"
                ]
              }
            ]
          },
          "then": {},
          "else": {
            "properties": {
              "inventory": {
                "required": [
                  "path"
                ],
                "properties": {
                  "path": {
                    "$ref": "#/$defs/path_any"
                  }
                }
              }
            },
            "required": [
              "inventory"
            ]
          }
        }
      ]
    },
    "map_string_to_string": {
      "type": "object",
      "description": "Arbitrary key/value map (values are strings).",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z_][A-Za-z0-9_]{0,127}$": {
          "type": "string"
        }
      }
    },
    "runner_identity": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "emit_principal_context": {
          "type": "boolean"
        },
        "probe_enabled": {
          "type": "boolean"
        },
        "probe_detail": {
          "type": "string",
          "enum": [
            "summary",
            "none"
          ]
        },
        "cache_policy": {
          "type": "string",
          "enum": [
            "disabled",
            "per_run_only",
            "cross_run_allowed"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_env_dsc_v3": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "config_path": {
          "$ref": "#/$defs/path_any"
        },
        "config_sha256": {
          "$ref": "#/$defs/sha256_hex"
        },
        "output_format": {
          "type": "string",
          "enum": [
            "json",
            "pretty-json"
          ]
        },
        "what_if_before_apply": {
          "type": "boolean"
        },
        "resource_type_allowlist": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "enabled": {
                "const": true
              }
            },
            "required": [
              "enabled"
            ]
          },
          "then": {
            "required": [
              "config_path",
              "config_sha256"
            ]
          }
        }
      ]
    },
    "runner_environment_config": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "off",
            "check_only",
            "apply"
          ]
        },
        "fail_mode": {
          "$ref": "#/$defs/fail_mode_enum"
        },
        "transport": {
          "type": "string",
          "enum": [
            "ssh",
            "winrm",
            "other"
          ]
        },
        "targets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/id_slug_v1"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "dsc_v3": {
          "$ref": "#/$defs/runner_env_dsc_v3"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "mode": {
                "const": "apply"
              }
            },
            "required": [
              "mode"
            ]
          },
          "then": {
            "required": [
              "targets"
            ],
            "properties": {
              "targets": {
                "minItems": 1
              }
            }
          }
        }
      ]
    },
    "runner_dependencies": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "allow_runtime_self_update": {
          "type": "boolean",
          "const": false
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_caldera": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "endpoint",
        "api_token_ref"
      ],
      "properties": {
        "endpoint": {
          "type": "string",
          "format": "uri"
        },
        "api_token_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "operation": {
          "type": "string"
        },
        "agent_selector": {
          "description": "Caldera agent selector (tags or asset ids).",
          "anyOf": [
            {
              "type": "string",
              "minLength": 1
            },
            {
              "type": "array",
              "items": {
                "type": "string",
                "minLength": 1
              },
              "minItems": 1,
              "uniqueItems": true
            }
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_atomic_prereqs": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "check_only",
            "check_then_get",
            "get_only"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_atomic_cleanup": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "invoke": {
          "type": "boolean"
        },
        "verify": {
          "type": "boolean"
        },
        "verification_profile": {
          "type": "string"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_atomic_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "fail_mode": {
          "$ref": "#/$defs/fail_mode_enum"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_atomic_synthetic_correlation_marker": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "method": {
          "type": "string",
          "enum": [
            "auto",
            "windows_eventlog",
            "syslog",
            "filelog"
          ]
        },
        "filelog_path": {
          "$ref": "#/$defs/path_any"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "method": {
                "const": "filelog"
              }
            },
            "required": [
              "method"
            ]
          },
          "then": {
            "required": [
              "filelog_path"
            ]
          }
        }
      ]
    },
    "runner_atomic_state_reconciliation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "allow_repair": {
          "type": "boolean",
          "const": false
        },
        "repair_allowlist_effect_types": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_atomic": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "atomic_root": {
          "$ref": "#/$defs/path_any"
        },
        "executor": {
          "type": "string",
          "enum": [
            "invoke_atomic_red_team",
            "atomic_operator",
            "other"
          ]
        },
        "timeout_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "prereqs": {
          "$ref": "#/$defs/runner_atomic_prereqs"
        },
        "capture_transcripts": {
          "type": "boolean"
        },
        "capture_terminal_recordings": {
          "type": "boolean"
        },
        "capture_executor_metadata": {
          "type": "boolean"
        },
        "cleanup": {
          "$ref": "#/$defs/runner_atomic_cleanup"
        },
        "requirements": {
          "$ref": "#/$defs/runner_atomic_requirements"
        },
        "synthetic_correlation_marker": {
          "$ref": "#/$defs/runner_atomic_synthetic_correlation_marker"
        },
        "state_reconciliation": {
          "$ref": "#/$defs/runner_atomic_state_reconciliation"
        },
        "technique_allowlist": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/attack_technique_id"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "technique_denylist": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/attack_technique_id"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "executor_allowlist": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_custom": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "command"
      ],
      "properties": {
        "command": {
          "type": "string",
          "minLength": 1
        },
        "args": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "env": {
          "$ref": "#/$defs/map_string_to_string"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner_plan_defaults": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "model_version": {
          "$ref": "#/$defs/semver"
        },
        "max_nodes": {
          "type": "integer",
          "minimum": 1
        },
        "max_concurrency": {
          "type": "integer",
          "minimum": 1
        },
        "fail_fast": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "runner": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "caldera",
            "atomic",
            "custom"
          ]
        },
        "identity": {
          "$ref": "#/$defs/runner_identity"
        },
        "targets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/id_slug_v1"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "environment_config": {
          "$ref": "#/$defs/runner_environment_config"
        },
        "dependencies": {
          "$ref": "#/$defs/runner_dependencies"
        },
        "caldera": {
          "$ref": "#/$defs/runner_caldera"
        },
        "atomic": {
          "$ref": "#/$defs/runner_atomic"
        },
        "custom": {
          "$ref": "#/$defs/runner_custom"
        },
        "plan": {
          "$ref": "#/$defs/runner_plan_defaults"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "caldera"
              }
            },
            "required": [
              "type"
            ]
          },
          "then": {
            "required": [
              "caldera"
            ],
            "not": {
              "anyOf": [
                {
                  "required": [
                    "atomic"
                  ]
                },
                {
                  "required": [
                    "custom"
                  ]
                }
              ]
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "atomic"
              }
            },
            "required": [
              "type"
            ]
          },
          "then": {
            "required": [
              "atomic"
            ],
            "not": {
              "anyOf": [
                {
                  "required": [
                    "caldera"
                  ]
                },
                {
                  "required": [
                    "custom"
                  ]
                }
              ]
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "custom"
              }
            },
            "required": [
              "type"
            ]
          },
          "then": {
            "required": [
              "custom"
            ],
            "not": {
              "anyOf": [
                {
                  "required": [
                    "caldera"
                  ]
                },
                {
                  "required": [
                    "atomic"
                  ]
                }
              ]
            }
          }
        }
      ]
    },
    "cache": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cross_run_allowed": {
          "type": "boolean"
        },
        "emit_cache_provenance": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "cross_run_allowed": {
                "const": true
              }
            },
            "required": [
              "cross_run_allowed"
            ]
          },
          "then": {
            "properties": {
              "emit_cache_provenance": {
                "const": true
              }
            },
            "required": [
              "emit_cache_provenance"
            ]
          }
        }
      ]
    },
    "control_plane_auth": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "username_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "password_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "private_key_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "token_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "control_plane_audit": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "control_plane": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "const": false
        },
        "transport": {
          "type": "string",
          "enum": [
            "ssh",
            "winrm",
            "grpc",
            "other"
          ]
        },
        "targets": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/id_slug_v1"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "auth": {
          "$ref": "#/$defs/control_plane_auth"
        },
        "audit": {
          "$ref": "#/$defs/control_plane_audit"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_otel_bookmarks": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "auto",
            "resume",
            "reset"
          ]
        },
        "checkpoint_dir": {
          "$ref": "#/$defs/path_any"
        },
        "flush_interval_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_otel_checkpoint_corruption": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "fail_closed",
            "recreate_fresh"
          ]
        },
        "require_fsync": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_otel_agent_liveness": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "startup_grace_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "required_metric_names": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_otel": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "config_path": {
          "$ref": "#/$defs/path_any"
        },
        "channels": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "bookmarks": {
          "$ref": "#/$defs/telemetry_otel_bookmarks"
        },
        "checkpoint_corruption": {
          "$ref": "#/$defs/telemetry_otel_checkpoint_corruption"
        },
        "agent_liveness": {
          "$ref": "#/$defs/telemetry_otel_agent_liveness"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "enabled": {
                "const": true
              }
            },
            "required": [
              "enabled"
            ]
          },
          "then": {
            "required": [
              "config_path"
            ]
          }
        }
      ]
    },
    "telemetry_baseline_profile": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "profile_path": {
          "$ref": "#/$defs/path_any"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "enabled": {
                "const": true
              }
            },
            "required": [
              "enabled"
            ]
          },
          "then": {
            "required": [
              "profile_path"
            ]
          }
        }
      ]
    },
    "path_run_raw": {
      "type": "string",
      "pattern": "^raw/[^\\r\\n]+$",
      "description": "Run-bundle-relative path under raw/."
    },
    "telemetry_source_osquery_otel_ingest": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "receiver_id": {
          "type": "string"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_source_osquery": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "output_path"
      ],
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "config_path": {
          "$ref": "#/$defs/path_any"
        },
        "results_log_path": {
          "$ref": "#/$defs/path_any"
        },
        "log_format": {
          "type": "string",
          "enum": [
            "event_ndjson",
            "batch_json"
          ]
        },
        "otel_ingest": {
          "$ref": "#/$defs/telemetry_source_osquery_otel_ingest"
        },
        "output_path": {
          "$ref": "#/$defs/path_run_raw"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_source_generic": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "enabled",
        "output_path"
      ],
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "config_path": {
          "$ref": "#/$defs/path_any"
        },
        "output_path": {
          "$ref": "#/$defs/path_run_raw"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_sources": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "osquery": {
          "$ref": "#/$defs/telemetry_source_osquery"
        },
        "pcap": {
          "$ref": "#/$defs/telemetry_source_generic"
        },
        "netflow": {
          "$ref": "#/$defs/telemetry_source_generic"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_payload_limits_sidecar": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "dir": {
          "$ref": "#/$defs/path_rel"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_payload_limits": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "max_event_xml_bytes": {
          "type": "integer",
          "minimum": 1
        },
        "max_field_chars": {
          "type": "integer",
          "minimum": 1
        },
        "max_binary_bytes": {
          "type": "integer",
          "minimum": 1
        },
        "sidecar": {
          "$ref": "#/$defs/telemetry_payload_limits_sidecar"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry_native_container_exports": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "dir": {
          "$ref": "#/$defs/path_rel"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "telemetry": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "otel": {
          "$ref": "#/$defs/telemetry_otel"
        },
        "baseline_profile": {
          "$ref": "#/$defs/telemetry_baseline_profile"
        },
        "sources": {
          "$ref": "#/$defs/telemetry_sources"
        },
        "payload_limits": {
          "$ref": "#/$defs/telemetry_payload_limits"
        },
        "native_container_exports": {
          "$ref": "#/$defs/telemetry_native_container_exports"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "normalization_dedupe": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "scope": {
          "type": "string",
          "enum": [
            "per_run"
          ]
        },
        "index_dir": {
          "$ref": "#/$defs/path_rel"
        },
        "conflict_policy": {
          "type": "string",
          "enum": [
            "warn",
            "fail_closed"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "normalization_raw_preservation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "policy": {
          "type": "string",
          "enum": [
            "none",
            "minimal",
            "full"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "normalization_output_parquet": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "compression": {
          "type": "string",
          "enum": [
            "zstd",
            "snappy",
            "none"
          ]
        },
        "row_group_size": {
          "type": "integer",
          "minimum": 1
        },
        "partitioning": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "normalization_output": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "format": {
          "type": "string",
          "enum": [
            "jsonl",
            "parquet"
          ]
        },
        "parquet": {
          "$ref": "#/$defs/normalization_output_parquet"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "normalization_source_type_mapping": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,128}$": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "normalization": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "ocsf_version"
      ],
      "properties": {
        "ocsf_version": {
          "type": "string",
          "minLength": 1
        },
        "mapping_profiles": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/path_any"
          },
          "minItems": 1
        },
        "source_type_mapping": {
          "$ref": "#/$defs/normalization_source_type_mapping"
        },
        "dedupe": {
          "$ref": "#/$defs/normalization_dedupe"
        },
        "strict_mode": {
          "type": "boolean"
        },
        "raw_preservation": {
          "$ref": "#/$defs/normalization_raw_preservation"
        },
        "output": {
          "$ref": "#/$defs/normalization_output"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "validation_entry_selectors": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "os": {
          "$ref": "#/$defs/os_enum"
        },
        "roles": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/asset_role_enum"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "executor": {
          "type": "string",
          "enum": [
            "atomic",
            "caldera",
            "custom"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "validation_criteria_pack": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pack_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "pack_version": {
          "$ref": "#/$defs/semver"
        },
        "paths": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/path_any"
          },
          "minItems": 1
        },
        "entry_selectors": {
          "$ref": "#/$defs/validation_entry_selectors"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "validation_evaluation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "time_window_before_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "time_window_after_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "max_sample_event_ids": {
          "type": "integer",
          "minimum": 1
        },
        "fail_mode": {
          "$ref": "#/$defs/fail_mode_enum"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "validation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "criteria_pack": {
          "$ref": "#/$defs/validation_criteria_pack"
        },
        "evaluation": {
          "$ref": "#/$defs/validation_evaluation"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "not": {
              "properties": {
                "enabled": {
                  "const": false
                }
              },
              "required": [
                "enabled"
              ]
            }
          },
          "then": {
            "required": [
              "criteria_pack"
            ],
            "properties": {
              "criteria_pack": {
                "required": [
                  "pack_id"
                ]
              }
            }
          }
        }
      ]
    },
    "detection_sigma_limits": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "max_rules": {
          "type": "integer",
          "minimum": 1
        },
        "max_compile_errors": {
          "type": "integer",
          "minimum": 0
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "detection_join": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "clock_skew_tolerance_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "detection_sigma_bridge_backend_options": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "table_name": {
          "type": "string",
          "minLength": 1
        },
        "output_format": {
          "type": "string",
          "minLength": 1
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "detection_sigma_bridge": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mapping_pack"
      ],
      "properties": {
        "mapping_pack": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "mapping_pack_version": {
          "$ref": "#/$defs/semver"
        },
        "backend": {
          "type": "string",
          "enum": [
            "duckdb_sql",
            "tenzir",
            "other"
          ]
        },
        "backend_options": {
          "$ref": "#/$defs/detection_sigma_bridge_backend_options"
        },
        "fail_mode": {
          "$ref": "#/$defs/fail_mode_enum"
        },
        "raw_fallback_enabled": {
          "type": "boolean"
        },
        "compile_cache_dir": {
          "$ref": "#/$defs/path_any"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "detection_sigma": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "rule_paths": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/path_any"
          },
          "minItems": 1
        },
        "rule_set_version": {
          "description": "Optional version identifier for the rule set (SemVer strongly recommended).",
          "anyOf": [
            {
              "$ref": "#/$defs/semver"
            },
            {
              "$ref": "#/$defs/version_token_v1"
            }
          ]
        },
        "bridge": {
          "$ref": "#/$defs/detection_sigma_bridge"
        },
        "limits": {
          "$ref": "#/$defs/detection_sigma_limits"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "not": {
              "properties": {
                "enabled": {
                  "const": false
                }
              },
              "required": [
                "enabled"
              ]
            }
          },
          "then": {
            "required": [
              "rule_paths"
            ]
          }
        }
      ]
    },
    "detection": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "batch",
            "streaming"
          ]
        },
        "sigma": {
          "$ref": "#/$defs/detection_sigma"
        },
        "join": {
          "$ref": "#/$defs/detection_join"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "scoring_thresholds": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "min_technique_coverage": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "max_allowed_latency_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "min_tier1_field_coverage": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "max_missing_telemetry_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "max_normalization_gap_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "max_bridge_gap_mapping_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "max_bridge_gap_feature_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "max_bridge_gap_other_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "scoring_weights": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "coverage_weight": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "latency_weight": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "fidelity_weight": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "scoring": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "gap_taxonomy": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "missing_telemetry",
              "criteria_unavailable",
              "criteria_misconfigured",
              "normalization_gap",
              "bridge_gap_mapping",
              "bridge_gap_feature",
              "bridge_gap_other",
              "rule_logic_gap",
              "cleanup_verification_failed"
            ]
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "thresholds": {
          "$ref": "#/$defs/scoring_thresholds"
        },
        "weights": {
          "$ref": "#/$defs/scoring_weights"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "reporting_requirements": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "detail_level": {
          "type": "string",
          "enum": [
            "summary",
            "full"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "policy_ref": {
      "$ref": "#/$defs/secret_ref_any"
    },
    "reporting_redaction": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "policy_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "reporting_regression_threshold_entry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "metric_id",
        "tolerance"
      ],
      "properties": {
        "metric_id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]{0,127}$"
        },
        "tolerance": {
          "type": "number"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "reporting_regression": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "baseline_run_id": {
          "$ref": "#/$defs/uuid"
        },
        "baseline_manifest_path": {
          "$ref": "#/$defs/path_rel"
        },
        "thresholds": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/reporting_regression_threshold_entry"
          },
          "minItems": 1
        },
        "alert_status_recommendation": {
          "type": "string",
          "enum": [
            "partial",
            "failed"
          ]
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "enabled": {
                "const": true
              }
            },
            "required": [
              "enabled"
            ]
          },
          "then": {
            "oneOf": [
              {
                "required": [
                  "baseline_run_id"
                ],
                "not": {
                  "required": [
                    "baseline_manifest_path"
                  ]
                }
              },
              {
                "required": [
                  "baseline_manifest_path"
                ],
                "not": {
                  "required": [
                    "baseline_run_id"
                  ]
                }
              }
            ]
          }
        }
      ]
    },
    "reporting": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "output_dir"
      ],
      "properties": {
        "output_dir": {
          "$ref": "#/$defs/path_any"
        },
        "emit_html": {
          "type": "boolean"
        },
        "emit_json": {
          "type": "boolean"
        },
        "include_debug_sections": {
          "type": "boolean"
        },
        "regression": {
          "$ref": "#/$defs/reporting_regression"
        },
        "requirements": {
          "$ref": "#/$defs/reporting_requirements"
        },
        "redaction": {
          "$ref": "#/$defs/reporting_redaction"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "operability_logging": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "level": {
          "type": "string",
          "enum": [
            "debug",
            "info",
            "warn",
            "error"
          ]
        },
        "json": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "operability_run_limits": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "max_run_minutes": {
          "type": "integer",
          "minimum": 1
        },
        "max_disk_gb": {
          "type": "number",
          "minimum": 0
        },
        "on_disk_exceed_behavior": {
          "type": "string",
          "enum": [
            "partial",
            "hard_fail"
          ]
        },
        "max_memory_mb": {
          "type": "integer",
          "minimum": 1
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "operability_health": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "emit_health_files": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "operability": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "logging": {
          "$ref": "#/$defs/operability_logging"
        },
        "run_limits": {
          "$ref": "#/$defs/operability_run_limits"
        },
        "health": {
          "$ref": "#/$defs/operability_health"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_redaction_limits": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "max_token_chars": {
          "type": "integer",
          "minimum": 1
        },
        "max_summary_chars": {
          "type": "integer",
          "minimum": 1
        },
        "max_field_chars": {
          "type": "integer",
          "minimum": 1
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_redaction": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "policy_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "limits": {
          "$ref": "#/$defs/security_redaction_limits"
        },
        "disabled_behavior": {
          "type": "string",
          "enum": [
            "withhold_from_long_term",
            "quarantine_unredacted"
          ]
        },
        "allow_unredacted_evidence_storage": {
          "type": "boolean"
        },
        "unredacted_dir": {
          "$ref": "#/$defs/path_rel"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_secrets_custom": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "executable": {
          "$ref": "#/$defs/path_abs"
        },
        "timeout_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "max_stdout_bytes": {
          "type": "integer",
          "minimum": 1
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_secrets_refs": {
      "type": "object",
      "description": "Map of secret identifiers to secret reference strings.",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,64}$": {
          "$ref": "#/$defs/secret_ref_any"
        }
      }
    },
    "security_secrets": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "provider": {
          "$ref": "#/$defs/secret_provider"
        },
        "refs": {
          "$ref": "#/$defs/security_secrets_refs"
        },
        "custom": {
          "$ref": "#/$defs/security_secrets_custom"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "provider": {
                "const": "custom"
              }
            },
            "required": [
              "provider"
            ]
          },
          "then": {
            "required": [
              "custom"
            ],
            "properties": {
              "custom": {
                "required": [
                  "executable"
                ]
              }
            }
          }
        }
      ]
    },
    "security_network_egress_canary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "address",
        "port"
      ],
      "properties": {
        "address": {
          "type": "string",
          "minLength": 1
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1
        },
        "required_on_deny": {
          "type": "boolean"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_network": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "allow_outbound": {
          "type": "boolean"
        },
        "allowlist": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "egress_canary": {
          "$ref": "#/$defs/security_network_egress_canary"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_signing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "key_ref": {
          "$ref": "#/$defs/secret_ref_any"
        },
        "algorithm": {
          "type": "string",
          "enum": [
            "ed25519"
          ]
        },
        "key_format": {
          "type": "string",
          "enum": [
            "ed25519_seed_base64"
          ]
        },
        "trusted_key_ids": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/hex64"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "enabled": {
                "const": true
              }
            },
            "required": [
              "enabled"
            ]
          },
          "then": {
            "required": [
              "key_ref"
            ]
          }
        }
      ]
    },
    "security": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "redaction": {
          "$ref": "#/$defs/security_redaction"
        },
        "secrets": {
          "$ref": "#/$defs/security_secrets"
        },
        "network": {
          "$ref": "#/$defs/security_network"
        },
        "signing": {
          "$ref": "#/$defs/security_signing"
        },
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      }
    },
    "security_secrets_refs_env": {
      "type": "object",
      "description": "Map of secret identifiers to secret reference strings.",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,64}$": {
          "$ref": "#/$defs/secret_ref_env"
        }
      }
    },
    "security_secrets_refs_file": {
      "type": "object",
      "description": "Map of secret identifiers to secret reference strings.",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,64}$": {
          "$ref": "#/$defs/secret_ref_file"
        }
      }
    },
    "security_secrets_refs_keychain": {
      "type": "object",
      "description": "Map of secret identifiers to secret reference strings.",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,64}$": {
          "$ref": "#/$defs/secret_ref_keychain"
        }
      }
    },
    "security_secrets_refs_custom": {
      "type": "object",
      "description": "Map of secret identifiers to secret reference strings.",
      "additionalProperties": false,
      "properties": {
        "extensions": {
          "$ref": "#/$defs/extensions"
        }
      },
      "patternProperties": {
        "^(?!extensions$)[A-Za-z0-9_.-]{1,64}$": {
          "$ref": "#/$defs/secret_ref_custom"
        }
      }
    }
  }
}