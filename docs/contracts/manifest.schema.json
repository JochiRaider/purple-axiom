{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://purple-axiom.local/schemas/manifest.schema.json",
  "title": "Purple Axiom Run Manifest",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "contract_version",
    "run_id",
    "status",
    "started_at_utc",
    "scenario",
    "versions",
    "inputs",
    "targets"
  ],
  "properties": {
    "contract_version": {
      "type": "string",
      "const": "0.1.0",
      "description": "Contract version for this manifest schema."
    },
    "run_id": {
      "type": "string",
      "description": "Run identifier (RFC 4122 UUID, canonical hyphenated lowercase).",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
    },
    "status": {
      "type": "string",
      "enum": [
        "success",
        "failed",
        "partial"
      ]
    },
    "started_at_utc": {
      "type": "string",
      "format": "date-time"
    },
    "ended_at_utc": {
      "type": "string",
      "format": "date-time"
    },
    "stage_outcomes": {
      "type": "array",
      "minItems": 1,
      "description": "Deterministic stage outcomes used for manifest.status derivation (see ADR-0005). Ordering is enforced by the orchestrator and is not fully expressible in JSON Schema.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "stage",
          "status",
          "fail_mode"
        ],
        "properties": {
          "stage": {
            "type": "string",
            "description": "Stable stage identifier. Substages MAY be dotted (e.g., telemetry.windows_eventlog.raw_mode).",
            "pattern": "^[a-z][a-z0-9_]*(?:\\.[a-z][a-z0-9_]*)*$"
          },
          "status": {
            "type": "string",
            "enum": [
              "success",
              "failed",
              "skipped"
            ]
          },
          "fail_mode": {
            "type": "string",
            "enum": [
              "fail_closed",
              "warn_and_skip"
            ]
          },
          "reason_code": {
            "type": "string",
            "description": "Stable reason token (ASCII lower_snake_case). Required when status != success.",
            "pattern": "^[a-z][a-z0-9_]*$"
          }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "status": {
                  "const": "success"
                }
              },
              "required": [
                "status"
              ]
            },
            "then": {
              "not": {
                "required": [
                  "reason_code"
                ]
              }
            },
            "else": {
              "required": [
                "reason_code"
              ]
            }
          }
        ]
      }
    },
    "scenario": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "scenario_id",
        "scenario_version",
        "runner_type",
        "techniques"
      ],
      "properties": {
        "scenario_id": {
          "type": "string",
          "description": "Stable scenario identifier (id_slug_v1; see ADR-0001).",
          "allOf": [
            {
              "$ref": "#/$defs/id_slug_v1"
            }
          ]
        },
        "scenario_version": {
          "type": "string",
          "description": "Scenario version (SemVer 2.0.0; see ADR-0001).",
          "$ref": "#/$defs/semver"
        },
        "runner_type": {
          "type": "string",
          "enum": [
            "atomic",
            "caldera",
            "custom"
          ]
        },
        "techniques": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^T\\d{4}(?:\\.\\d{3})?$"
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "plan_path": {
          "type": "string",
          "description": "Optional path to the scenario plan file used for this run (relative or absolute)."
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "versions": {
      "description": "Version pins and provenance. v0.2.0 supports both legacy (v0.1) and ADR-0001-aligned shapes.",
      "oneOf": [
        {
          "$ref": "#/$defs/versions_v1_legacy"
        },
        {
          "$ref": "#/$defs/versions_v2_pins"
        }
      ]
    },
    "inputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "range_yaml_sha256"
      ],
      "properties": {
        "range_yaml_sha256": {
          "type": "string",
          "description": "SHA-256 of the exact bytes of range.yaml (lowercase hex).",
          "$ref": "#/$defs/sha256_hex"
        },
        "otel_config_sha256": {
          "type": "string",
          "description": "SHA-256 of the effective OpenTelemetry Collector configuration used (lowercase hex).",
          "$ref": "#/$defs/sha256_hex"
        },
        "mapping_profiles": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "sigma_rule_paths": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        },
        "runner_inputs_sha256": {
          "description": "SHA-256 of canonical JSON of runner inputs (redacted) when recorded (lowercase hex).",
          "$ref": "#/$defs/sha256_hex"
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "lab": {
      "type": "object",
      "description": "Optional lab/provider provenance. This is additive; targets[] remains the v0.1 baseline.",
      "additionalProperties": false,
      "properties": {
        "provider": {
          "type": "string",
          "description": "Lab provider identity (see lab provider spec).",
          "enum": [
            "manual",
            "ludus",
            "terraform",
            "other"
          ]
        },
        "inventory_snapshot_sha256": {
          "type": "string",
          "description": "SHA-256 of the resolved inventory snapshot used for this run (lowercase hex).",
          "$ref": "#/$defs/sha256_hex"
        },
        "assets": {
          "type": "array",
          "description": "Optional resolved asset list used by the run. asset_id is the stable join key.",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "asset_id"
            ],
            "properties": {
              "asset_id": {
                "type": "string",
                "minLength": 1
              },
              "hostname": {
                "type": "string"
              },
              "ip_addresses": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "uniqueItems": true
              },
              "labels": {
                "type": "array",
                "items": {
                  "type": "string",
                  "minLength": 1
                },
                "uniqueItems": true
              }
            }
          }
        }
      }
    },
    "targets": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "asset_id",
          "os",
          "role"
        ],
        "properties": {
          "asset_id": {
            "type": "string",
            "minLength": 1
          },
          "os": {
            "type": "string",
            "enum": [
              "windows",
              "linux",
              "macos",
              "other"
            ]
          },
          "role": {
            "type": "string",
            "enum": [
              "endpoint",
              "server",
              "domain_controller",
              "workstation",
              "other"
            ]
          },
          "hostname": {
            "type": "string"
          },
          "ip_addresses": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "uniqueItems": true
          }
        }
      }
    },
    "artifacts": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ground_truth_path": {
          "type": "string"
        },
        "raw_dir": {
          "type": "string"
        },
        "normalized_dir": {
          "type": "string"
        },
        "detections_dir": {
          "type": "string"
        },
        "scoring_dir": {
          "type": "string"
        },
        "report_dir": {
          "type": "string"
        },
        "checksums_path": {
          "type": "string"
        },
        "signature_path": {
          "type": "string"
        }
      }
    },
    "extensions": {
      "type": "object",
      "description": "Reserved for forward-compatible additions; namespace keys map to structured extension objects.",
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {
          "description": "Namespaced extension payload.",
          "oneOf": [
            {
              "type": "object",
              "properties": {
                "v": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Optional schema version for this namespace."
                }
              },
              "additionalProperties": true
            },
            {
              "type": "string"
            },
            {
              "type": "number"
            },
            {
              "type": "boolean"
            },
            {
              "type": "array"
            },
            {
              "type": "null"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "placeholder": {
      "$ref": "#/$defs/pa_placeholder_v1"
    }
  },
  "$defs": {
    "sha256_hex": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$"
    },
    "semver": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?(?:\\+[0-9A-Za-z-]+(?:\\.[0-9A-Za-z-]+)*)?$"
    },
    "id_slug_v1": {
      "type": "string",
      "description": "ADR-0001 id_slug_v1: ASCII lowercase, a-z0-9-, 1..64 chars, no double-hyphen.",
      "allOf": [
        {
          "pattern": "^[a-z0-9](?:[a-z0-9-]{0,62}[a-z0-9])$"
        },
        {
          "not": {
            "pattern": "--"
          }
        }
      ]
    },
    "contracts_pin_map": {
      "type": "object",
      "description": "Optional map of contract_id -> contract_version for contracts relevant to this run (see ADR-0001). Cross-artifact validation MUST ensure these values match the contract_version const of produced artifacts' schemas.",
      "patternProperties": {
        "^[a-z][a-z0-9_]*$": {
          "$ref": "#/$defs/semver"
        }
      },
      "additionalProperties": false
    },
    "versions_v1_legacy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "purple_axiom",
        "ocsf_version",
        "normalizer_version"
      ],
      "properties": {
        "purple_axiom": {
          "type": "string",
          "minLength": 1,
          "description": "Legacy project version stamp (v0.1). Prefer versions.project_version going forward."
        },
        "pipeline_version": {
          "type": "string",
          "minLength": 1,
          "description": "Convenience alias for the full pipeline version stamp."
        },
        "ocsf_version": {
          "type": "string",
          "minLength": 1
        },
        "otel_collector_version": {
          "type": "string",
          "minLength": 1
        },
        "osquery_version": {
          "type": "string",
          "minLength": 1
        },
        "runner_version": {
          "type": "string",
          "minLength": 1
        },
        "normalizer_version": {
          "type": "string",
          "minLength": 1
        },
        "sigma_compiler_version": {
          "type": "string",
          "minLength": 1
        },
        "contracts": {
          "$ref": "#/$defs/contracts_pin_map"
        }
      }
    },
    "versions_v2_pins": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "project_version",
        "pipeline_version",
        "scenario_id",
        "scenario_version",
        "ocsf_version"
      ],
      "properties": {
        "project_version": {
          "description": "Purple Axiom release version (SemVer; ADR-0001).",
          "$ref": "#/$defs/semver"
        },
        "pipeline_version": {
          "description": "Pipeline definition version (SemVer; ADR-0001).",
          "$ref": "#/$defs/semver"
        },
        "scenario_id": {
          "description": "Scenario id pin (ADR-0001).",
          "$ref": "#/$defs/id_slug_v1"
        },
        "scenario_version": {
          "description": "Scenario version pin (SemVer; ADR-0001).",
          "$ref": "#/$defs/semver"
        },
        "ocsf_version": {
          "type": "string",
          "minLength": 1,
          "description": "Pinned OCSF version. If not SemVer, record the exact upstream version string."
        },
        "criteria_pack_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "criteria_pack_version": {
          "$ref": "#/$defs/semver"
        },
        "rule_set_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "rule_set_version": {
          "type": "string",
          "minLength": 1
        },
        "mapping_pack_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "mapping_pack_version": {
          "$ref": "#/$defs/semver"
        },
        "runner_version": {
          "type": "string",
          "minLength": 1
        },
        "collector_version": {
          "type": "string",
          "minLength": 1
        },
        "normalizer_version": {
          "type": "string",
          "minLength": 1
        },
        "evaluator_version": {
          "type": "string",
          "minLength": 1
        },
        "contracts": {
          "$ref": "#/$defs/contracts_pin_map"
        }
      },
      "allOf": [
        {
          "description": "If present, versions.contracts MUST include entries for every contract-backed artifact that was published for the run. Equality against actual produced artifacts is enforced by the contract validation/publish-gate engine."
        }
      ]
    },
    "pa_placeholder_v1": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "placeholder_version",
        "handling",
        "reason_code",
        "reason_domain"
      ],
      "properties": {
        "placeholder_version": {
          "type": "string",
          "const": "pa.placeholder.v1"
        },
        "handling": {
          "type": "string",
          "enum": [
            "withheld",
            "quarantined",
            "absent"
          ]
        },
        "reason_code": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "reason_domain": {
          "type": "string",
          "const": "artifact_placeholder"
        },
        "sha256": {
          "type": "string",
          "pattern": "^sha256:[0-9a-f]{64}$"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "handling": {
                "const": "absent"
              }
            },
            "required": [
              "handling"
            ]
          },
          "then": {
            "properties": {
              "sha256": false
            }
          }
        }
      ]
    }
  }
}
