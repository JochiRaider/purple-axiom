# file: docs/project_viz/architecture/system_model.yaml
version: 1
system:
  id: purple_ci_orchestrator
  name: Purple Team CI Orchestrator
  description: Runs purple-team exercises in CI, collects telemetry, normalizes to OCSF, evaluates detections, scores, and reports.
  evidence:
    - file: 000_charter.md
      section_heading: Purpose
      excerpt: deliver repeatable purple team exercises in CI

trust_zones:
  - id: developer_workstation
    name: Developer Workstation
    description: Local machine used by an operator to run the CLI.
    evidence:
      - file: 020_architecture.md
        section_heading: Overview
        excerpt: Operators and CI drive the orchestrator via a small set of verbs.
  - id: ci_environment
    name: CI Environment
    description: CI runner executing the orchestrator pipeline.
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: Definitions
        excerpt: An external harness (CI workflow, Make target, etc.) that runs purple-axiom.
  - id: lab_range
    name: Lab Range
    description: Lab environment hosting target assets and telemetry collectors.
    evidence:
      - file: 015_lab_providers.md
        section_heading: Scope
        excerpt: Support multiple lab providers by normalizing inventory into a canonical snapshot.
  - id: local_filesystem
    name: Local Filesystem
    description: Workspace root containing run bundles and caches.
    evidence:
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: runs/<run_id>/ is the root of a run bundle on disk.

actors:
  - id: operator
    name: Operator
    type: human
    description: Runs the orchestrator and inspects artifacts.
    trust_zone: developer_workstation
    evidence:
      - file: 115_operator_interface.md
        section_heading: Goals
        excerpt: Provide a web UI for manual triggering and artifact browsing.
  - id: ci_system
    name: CI System
    type: system
    description: Executes the orchestrator as a CI job.
    trust_zone: ci_environment
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: CI contract
        excerpt: CI MUST capture the run_id and export bundle artifacts.

externals:
  - id: otel_collector_agent
    name: OTel Collector Agent
    type: external_agent
    description: OpenTelemetry Collector agent tier deployed on target assets; exports telemetry upstream.
    trust_zone: lab_range
    evidence:
      - file: 040_telemetry_pipeline.md
        section_heading: Canonical topology
        excerpt: Agent tier exists even if a gateway is later added.
  - id: otel_collector_gateway
    name: OTel Collector Gateway
    type: external_system
    description: Optional OpenTelemetry Collector gateway tier receiving OTLP from agents for buffering and fan-out.
    trust_zone: ci_environment
    evidence:
      - file: 040_telemetry_pipeline.md
        section_heading: Collector tiers
        excerpt: Gateway tier receives OTLP from agents and applies buffering and fan-out.
  - id: golden_dataset_builder
    name: Golden Dataset Builder
    type: external_system
    description: Implementation-defined job/tooling that generates and publishes golden dataset releases.
    trust_zone: ci_environment
    evidence:
      - file: 085_golden_datasets.md
        section_heading: Generation
        excerpt: Dataset build process is implementation-defined.
  - id: lab_provider_sources
    name: Lab Provider Sources
    type: external_system
    description: Range inventory sources (Ludus export, Terraform output, Vagrant export).
    trust_zone: lab_range
    evidence:
      - file: 015_lab_providers.md
        section_heading: Lab provider resolvers (v0.1)
        excerpt: 'ludus: import range inventory from Ludus export JSON.'
  - id: detection_baseline_library
    name: Detection Baseline Library
    type: external_package
    description: Baseline dataset library used for regression and reporting comparisons.
    trust_zone: ci_environment
    evidence:
      - file: 086_detection_baseline_library.md
        section_heading: Summary
        excerpt: stores baseline datasets for detections, scoring, and reporting.
  - id: sigma_rule_packs
    name: Sigma Rule Packs
    type: external_package
    description: Sigma rule repositories evaluated by detection stage.
    trust_zone: ci_environment
    evidence:
      - file: 060_detection_sigma.md
        section_heading: Inputs
        excerpt: Detection stage consumes Sigma rule packs and a mapping pack.
  - id: sigma_to_ocsf_mapping_packs
    name: Sigma-to-OCSF Mapping Packs
    type: external_package
    description: Mapping packs used by sigma-to-ocsf bridge.
    trust_zone: ci_environment
    evidence:
      - file: 065_sigma_to_ocsf_bridge.md
        section_heading: Mapping packs
        excerpt: bridge MUST resolve a mapping pack
  - id: mapping_profile_pack
    name: Mapping Profile Pack
    type: external_package
    description: OCSF mapping profile configuration for normalization.
    trust_zone: ci_environment
    evidence:
      - file: 050_normalization_ocsf.md
        section_heading: Mapping profiles
        excerpt: Normalization uses mapping profiles to map raw fields into OCSF.
  - id: contract_registry
    name: Contract Registry
    type: external_service
    description: Registry providing schemas for contract validation when present.
    trust_zone: ci_environment
    evidence:
      - file: 015_lab_providers.md
        section_heading: Publish and validation gate
        excerpt: "validate the snapshot (schema ... via the contract registry)."
  - id: target_osquery_agent
    name: Target osquery agent
    type: external_agent
    description: Optional osquery agent on target hosts producing telemetry.
    trust_zone: lab_range
    evidence:
      - file: 042_osquery_integration.md
        section_heading: Overview
        excerpt: Osquery integration provides host telemetry for the pipeline.
  - id: atomic_red_team
    name: Atomic Red Team
    type: external_package
    description: Atomic Red Team tests used by runner stage.
    trust_zone: ci_environment
    evidence:
      - file: 032_atomic_red_team_executor_integration.md
        section_heading: Definitions
        excerpt: Atomic Red Team tests: pinned exact version.
  - id: invoke_atomic_red_team
    name: Invoke-AtomicRedTeam module
    type: external_package
    description: Atomic Red Team PowerShell executor module used by runner.
    trust_zone: ci_environment
    evidence:
      - file: 032_atomic_red_team_executor_integration.md
        section_heading: Definitions
        excerpt: 'Invoke-AtomicRedTeam module: pinned exact version.'
  - id: threat_intel_packs
    name: Threat Intelligence Packs
    type: external_package
    description: Optional threat intel packs used for enrichment and reporting.
    trust_zone: ci_environment
    evidence:
      - file: ADR-0008-Threat-intelligence-integration-model.md
        section_heading: Interaction with run-bundle snapshots
        excerpt: 'inputs/threat_intel/manifest.json and inputs/threat_intel/indicators.jsonl'

containers:
  - id: orchestrator_cli
    name: Orchestrator CLI
    kind: service
    trust_zone: ci_environment
    description: Main CLI that coordinates stages and manages run bundles.
    evidence:
      - file: 020_architecture.md
        section_heading: Orchestrator CLI
        excerpt: Coordinates pipeline stages and enforces contracts between them.
  - id: matrix_runner
    name: Matrix Runner
    kind: service
    trust_zone: ci_environment
    description: CI harness that runs the orchestrator for a scenario matrix and evaluates results.
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: Definitions
        excerpt: An external harness (CI workflow, Make target, etc.) that runs purple-axiom.
  - id: operator_interface
    name: Operator Interface
    kind: service
    trust_zone: ci_environment
    description: Optional web UI and API for running and inspecting runs (v0.2+).
    evidence:
      - file: 020_architecture.md
        section_heading: Packaging model
        excerpt: A single docker container packs the orchestrator + Operator Interface web server.
  - id: lab_provider
    name: Lab Provider Stage
    kind: stage
    trust_zone: ci_environment
    description: Resolves and snapshots lab inventory for a run.
    evidence:
      - file: 020_architecture.md
        section_heading: Lab provider (inventory)
        excerpt: resolves and snapshots lab inventory for a run.
  - id: runner
    name: Runner Stage
    kind: stage
    trust_zone: ci_environment
    description: Executes scenario actions (adversary emulation) and writes ground truth.
    evidence:
      - file: 020_architecture.md
        section_heading: Runner (adversary emulation)
        excerpt: v0.1 uses Atomic Red Team
  - id: telemetry
    name: Telemetry Stage
    kind: stage
    trust_zone: ci_environment
    description: Collects telemetry and validates presence/quality of signals.
    evidence:
      - file: 020_architecture.md
        section_heading: Telemetry (collection and validation)
        excerpt: 'Write raw event store: `raw_parquet/**` (Parquet).'
  - id: normalization
    name: Normalization Stage
    kind: stage
    trust_zone: ci_environment
    description: Normalizes raw telemetry into OCSF and emits mapping coverage.
    evidence:
      - file: 020_architecture.md
        section_heading: Normalization (OCSF)
        excerpt: Normalization transforms raw events into OCSF and emits mapping coverage.
  - id: validation
    name: Validation Stage
    kind: stage
    trust_zone: ci_environment
    description: Evaluates validation criteria and writes results into the run bundle.
    evidence:
      - file: 035_validation_criteria.md
        section_heading: Overview
        excerpt: Validation criteria are evaluated against normalized events and run artifacts.
  - id: sigma_to_ocsf_bridge_adapter
    name: Sigma-to-OCSF Bridge Adapter
    kind: service
    trust_zone: ci_environment
    description: Adapter wrapper that calls sigma-to-ocsf bridge library.
    evidence:
      - file: 065_sigma_to_ocsf_bridge.md
        section_heading: Overview
        excerpt: The bridge translates Sigma rules into OCSF-compatible query predicates.
  - id: detection
    name: Detection Stage
    kind: stage
    trust_zone: ci_environment
    description: Evaluates Sigma detections via sigma-to-ocsf bridge and writes detections.
    evidence:
      - file: 060_detection_sigma.md
        section_heading: Overview
        excerpt: Detection stage evaluates Sigma rules over normalized events.
  - id: scoring
    name: Scoring Stage
    kind: stage
    trust_zone: ci_environment
    description: Computes scoring metrics and summary for a run.
    evidence:
      - file: 070_scoring_metrics.md
        section_heading: Overview
        excerpt: Scoring aggregates criteria and detections into metrics and thresholds.
  - id: reporting
    name: Reporting Stage
    kind: stage
    trust_zone: ci_environment
    description: Produces report artifacts and optional regression comparisons.
    evidence:
      - file: 080_reporting.md
        section_heading: Reporting stage responsibilities
        excerpt: The reporting stage transforms scoring outputs into actionable artifacts.
  - id: signing
    name: Signing Stage
    kind: stage
    trust_zone: ci_environment
    description: Produces integrity artifacts (checksums and signature) for run outputs.
    evidence:
      - file: 020_architecture.md
        section_heading: Signing
        excerpt: produces integrity artifacts: `security/checksums.txt` and `security/signature.*`.
  - id: audit_redactor
    name: Audit Redaction Pipeline
    kind: service
    trust_zone: ci_environment
    description: Redacts sensitive content from operator-facing exports.
    evidence:
      - file: ADR-0003-redaction-policy.md
        section_heading: Decision
        excerpt: All operator-facing exports MUST run through the redaction pipeline.

datastores:
  - id: run_bundle_store
    name: Run Bundle Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - run_bundle
      - evidence_artifacts
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Run bundle (coordination and evidence plane)
        excerpt: Run bundle (`runs/<run_id>/`) is the filesystem contract boundary between stages.
  - id: unredacted_quarantine
    name: Unredacted Quarantine
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - unredacted_sensitive
    evidence:
      - file: 090_security_safety.md
        section_heading: Redaction and quarantine
        excerpt: "Quarantine location: `runs/<run_id>/unredacted/` (default)."      
  - id: run_lock_dir
    name: Run lock directory (runs/.locks/)
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - lockfiles
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Orchestrator (execution plane)
        excerpt: 'atomic creation of `runs/.locks/<run_id>.lock`.'
  - id: workspace_cache
    name: Workspace Cache
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - caches
      - downloaded_packs
    evidence:
      - file: 020_architecture.md
        section_heading: Workspace boundary (normative, v0.1)
        excerpt: 'Cache (optional): `<workspace_root>/cache/`.'
  - id: workspace_exports
    name: Workspace Exports
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - exports
    evidence:
      - file: 020_architecture.md
        section_heading: Workspace boundary (normative, v0.1)
        excerpt: "Exports (reserved): `<workspace_root>/exports/`."
  - id: baseline_library
    name: Baseline Library
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - baseline_packages
    evidence:
      - file: 086_detection_baseline_library.md
        section_heading: Storage location and addressing
        excerpt: stored in `exports/baselines/<baseline_id>/<baseline_version>/`.
  - id: golden_dataset_store
    name: Golden Dataset Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - golden_datasets
    evidence:
      - file: 085_golden_datasets.md
        section_heading: Location
        excerpt: exports/datasets/<dataset_id>/<dataset_version>/        
  - id: raw_parquet_store
    name: Raw Parquet Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: parquet
    data_classes:
      - raw_events
    evidence:
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: '`raw_parquet/` is stored as a Parquet dataset.'
  - id: raw_artifacts_store
    name: Raw Artifact Preservation Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - raw_artifacts
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: "`raw_parquet/**`, `raw/**` (when raw preservation enabled)"        
  - id: normalized_ocsf_store
    name: Normalized OCSF Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: parquet
    data_classes:
      - normalized_events
    evidence:
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: 'Normalized store: `normalized/ocsf_events/` (Parquet).'
  - id: detections_store
    name: Detections Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: jsonl
    data_classes:
      - detections
    evidence:
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: Detections are stored as JSONL under `detections/`.
  - id: scoring_store
    name: Scoring Store
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: json
    data_classes:
      - scoring_summary
    evidence:
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: Scoring summary is stored as `scoring/summary.json`.
  - id: report_artifacts
    name: Report Artifacts
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: json
    data_classes:
      - report
      - thresholds
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: CI contract
        excerpt: '`runs/<run_id>/report/thresholds.json` and `runs/<run_id>/report/report.json` MUST be'
  - id: integrity_artifacts
    name: Integrity Artifacts
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: text
    data_classes:
      - checksums
      - signature
    evidence:
      - file: 120_config_reference.md
        section_heading: signing
        excerpt: 'algorithm: "ed25519"'
  - id: audit_log_store
    name: Audit Log Store
    kind: filesystem_file
    trust_zone: local_filesystem
    tech: jsonl
    data_classes:
      - ui_audit_events
    evidence:
      - file: 115_operator_interface.md
        section_heading: Audit
        excerpt: 'UI audit events are appended to logs/ui_audit.jsonl.'
  - id: staging_area
    name: Staging Area
    kind: filesystem_dir
    trust_zone: local_filesystem
    tech: filesystem
    data_classes:
      - staging_artifacts
    evidence:
      - file: 000_charter.md
        section_heading: Guiding principles
        excerpt: 'Stages write to a staging location (`.staging/`).'

buses:
  - id: otlp_stream
    name: OTLP Stream
    kind: telemetry_bus
    trust_zone: lab_range
    tech: OTLP
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Telemetry plane
        excerpt: OTLP MAY be used between Collector tiers

relationships:
  - from: operator
    to: orchestrator_cli
    label: invoke lifecycle verbs
    interaction: request_response
    protocol: unknown
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 020_architecture.md
        section_heading: Overview
        excerpt: Operators and CI drive the orchestrator via a small set of verbs.
  - from: operator
    to: operator_interface
    label: use web UI for manual triggering and artifact browsing
    views: [context, ui]
    interaction: request_response
    protocol: unknown
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 115_operator_interface.md
        section_heading: Goals
        excerpt: Provide a web UI for manual triggering and artifact browsing.
  - from: operator_interface
    to: audit_log_store
    label: append UI audit events
    views: [ui]
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - logs/ui_audit.jsonl
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 115_operator_interface.md
        section_heading: Audit
        excerpt: 'UI audit events are appended to logs/ui_audit.jsonl.'
  - from: matrix_runner
    to: orchestrator_cli
    label: run orchestrator in CI
    interaction: request_response
    protocol: unknown
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: Definitions
        excerpt: An external harness (CI workflow, Make target, etc.) that runs purple-axiom.
  - from: orchestrator_cli
    to: run_lock_dir
    label: acquire run lock
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - runs/.locks/<run_id>.lock
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Orchestrator (execution plane)
        excerpt: atomic creation of `runs/.locks/<run_id>.lock`.
  - from: orchestrator_cli
    to: run_bundle_store
    label: create and mutate run bundle
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - runs/<run_id>/**
      - runs/<run_id>/manifest.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Run bundle (coordination and evidence plane)
        excerpt: The run bundle (`runs/<run_id>/`) is the authoritative coordination substrate for all core stages.
  - from: orchestrator_cli
    to: lab_provider
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Orchestrator (execution plane)
        excerpt: execute the core pipeline stages in a single process
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: 'build: Execute `lab_provider` stage only.'
  - from: orchestrator_cli
    to: runner
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[runner] execute scenario actions -> write ground_truth.jsonl'
  - from: orchestrator_cli
    to: telemetry
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[telemetry] ensure collection window captured'
  - from: orchestrator_cli
    to: normalization
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[normalization] map raw_parquet/** -> publish normalized/**'
  - from: orchestrator_cli
    to: validation
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[validation] snapshot criteria pack + evaluate criteria'
  - from: orchestrator_cli
    to: detection
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[detection] compile/evaluate sigma via bridge'
  - from: orchestrator_cli
    to: scoring
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[scoring] join ground truth, criteria, detections'
  - from: orchestrator_cli
    to: reporting
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[reporting] (optional regression) materialize inputs/baseline/**'
  - from: orchestrator_cli
    to: signing
    label: invoke stage
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[signing] (optional) sign artifacts -> publish security/**'
  - from: orchestrator_cli
    to: audit_redactor
    label: export redaction pipeline
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0003-redaction-policy.md
        section_heading: Decision
        excerpt: All operator-facing exports MUST run through the redaction pipeline.
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: 'export: package a run bundle for sharing.'        
  - from: lab_provider
    to: lab_provider_sources
    label: import inventory
    interaction: batch
    protocol: unknown
    auth: unknown
    data:
      - ludus export JSON
      - terraform output
      - vagrant export
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 015_lab_providers.md
        section_heading: Lab provider resolvers (v0.1)
        excerpt: 'terraform: import range inventory from Terraform output.'
  - from: lab_provider
    to: contract_registry
    label: validate inventory snapshot against contracts
    interaction: batch
    protocol: unknown
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 015_lab_providers.md
        section_heading: Publish and validation gate
        excerpt: "validate the snapshot (schema ... via the contract registry)."        
  - from: lab_provider
    to: run_bundle_store
    label: publish inventory snapshot
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - logs/lab_inventory_snapshot.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0009-run-export-policy-and-log-classification.md
        section_heading: Deterministic evidence logs allowlist (normative)
        excerpt: logs/lab_inventory_snapshot.json
      - file: 020_architecture.md
        section_heading: Lab provider (inventory)
        excerpt: resolves and snapshots lab inventory for a run.
  - from: lab_provider
    to: runner
    label: provide inventory snapshot
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - inventory snapshot
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 032_atomic_red_team_executor_integration.md
        section_heading: Inventory snapshot consumption
        excerpt: inventory snapshot produced by the lab provider stage
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: inventory snapshot, scenario plan
  - from: runner
    to: atomic_red_team
    label: execute Atomic Red Team actions
    interaction: request_response
    protocol: unknown
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 020_architecture.md
        section_heading: Runner (adversary emulation)
        excerpt: v0.1 uses Atomic Red Team
  - from: runner
    to: invoke_atomic_red_team
    label: invoke executor module
    interaction: request_response
    protocol: PowerShell
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 032_atomic_red_team_executor_integration.md
        section_heading: Invoke-AtomicRedTeam remote mapping
        excerpt: execute `Invoke-AtomicTest` within that session.
      - file: 032_atomic_red_team_executor_integration.md
        section_heading: Definitions
        excerpt: 'Invoke-AtomicRedTeam module: pinned exact version'
  - from: runner
    to: run_bundle_store
    label: write ground truth and runner evidence
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - ground_truth.jsonl
      - runner/actions/<action_id>/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`ground_truth.jsonl`, `runner/actions/<action_id>/**` evidence'
      - file: 032_atomic_red_team_executor_integration.md
        section_heading: Contracted runner artifacts (normative)
        excerpt: Action-scoped runner evidence: `runs/<run_id>/runner/actions/<action_id>/`.
  - from: runner
    to: telemetry
    label: provide ground truth for collection window
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - ground_truth.jsonl
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`ground_truth.jsonl` lifecycle timestamps'
  - from: telemetry
    to: raw_parquet_store
    label: write raw telemetry Parquet
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - raw_parquet/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 020_architecture.md
        section_heading: Telemetry (collection and validation)
        excerpt: 'Write raw event store: `raw_parquet/**` (Parquet).'
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: '`raw_parquet/` is stored as a Parquet dataset.'
  - from: telemetry
    to: raw_artifacts_store
    label: optionally preserve raw artifacts
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - raw/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: "`raw_parquet/**`, `raw/**` (when raw preservation enabled)"        
  - from: telemetry
    to: run_bundle_store
    label: write telemetry validation evidence
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - logs/telemetry_validation.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0009-run-export-policy-and-log-classification.md
        section_heading: Deterministic evidence logs allowlist (normative)
        excerpt: logs/telemetry_validation.json
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: logs/telemetry_validation.json
  - from: otel_collector_agent
    to: otlp_stream
    label: export telemetry
    interaction: async_message
    protocol: OTLP
    auth: unknown
    data:
      - OTLP telemetry
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Telemetry plane
        excerpt: OTLP MAY be used between Collector tiers
  - from: otlp_stream
    to: otel_collector_gateway
    label: deliver telemetry to gateway
    interaction: async_message
    protocol: OTLP
    auth: unknown
    data:
      - OTLP telemetry
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Telemetry plane
        excerpt: gateway tier receives OTLP from agents
  - from: normalization
    to: mapping_profile_pack
    label: load mapping profiles
    views: [pipeline]
    interaction: batch
    protocol: filesystem
    auth: unknown
    data:
      - mapping profiles
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 050_normalization_ocsf.md
        section_heading: Mapping profiles
        excerpt: Normalization uses mapping profiles to map raw fields into OCSF.
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`raw_parquet/**`, mapping profiles'  
  - from: normalization
    to: normalized_ocsf_store
    label: write normalized OCSF events
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - normalized/ocsf_events/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 045_storage_formats.md
        section_heading: Run bundle filesystem layout (v0.1)
        excerpt: 'Normalized store: `normalized/ocsf_events/` (Parquet).'
  - from: normalization
    to: run_bundle_store
    label: write mapping coverage and profile snapshot
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - normalized/mapping_coverage.json
      - normalized/mapping_profile_snapshot.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 020_architecture.md
        section_heading: Normalization (OCSF)
        excerpt: 'Emit mapping coverage: `normalized/mapping_coverage.json`.'
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`normalized/mapping_profile_snapshot.json`'
  - from: normalization
    to: validation
    label: provide normalized events
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - normalized/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`ground_truth.jsonl`, `normalized/**`, criteria pack snapshot'
  - from: validation
    to: run_bundle_store
    label: publish criteria snapshot and results
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - criteria/manifest.json
      - criteria/criteria.jsonl
      - criteria/results.jsonl
      - criteria/summary.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`criteria/manifest.json`, `criteria/criteria.jsonl`, `criteria/results.jsonl`'
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`criteria/results.jsonl`, `criteria/summary.json`'      
      - file: 035_validation_criteria.md
        section_heading: Run bundle snapshot
        excerpt: validation stage MUST snapshot the selected criteria pack into the run bundle.
  - from: validation
    to: scoring
    label: provide criteria results
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - criteria/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`ground_truth.jsonl`, `criteria/**`, `detections/**`, `normalized/**`'
  - from: detection
    to: sigma_rule_packs
    label: load Sigma rule packs
    interaction: batch
    protocol: filesystem
    auth: unknown
    data:
      - Sigma rule packs
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: Sigma rule packs
  - from: detection
    to: sigma_to_ocsf_mapping_packs
    label: resolve mapping pack
    interaction: batch
    protocol: filesystem
    auth: unknown
    data:
      - mapping pack
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 065_sigma_to_ocsf_bridge.md
        section_heading: Mapping packs
        excerpt: bridge MUST resolve a mapping pack
  - from: detection
    to: sigma_to_ocsf_bridge_adapter
    label: compile/evaluate Sigma via bridge adapter
    views: [pipeline]
    interaction: request_response
    protocol: local_process
    auth: unknown
    data: []
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[detection] compile/evaluate sigma via bridge'
      - file: 060_detection_sigma.md
        section_heading: Overview
        excerpt: Rules are evaluated against normalized OCSF events (not raw logs) using the Sigma-to-OCSF Bridge.        
  - from: detection
    to: run_bundle_store
    label: publish bridge artifacts and detections
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - bridge/**
      - detections/detections.jsonl
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`bridge/**`, `detections/detections.jsonl`'
  - from: detection
    to: scoring
    label: provide detections
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - detections/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`ground_truth.jsonl`, `criteria/**`, `detections/**`, `normalized/**`'
  - from: scoring
    to: run_bundle_store
    label: publish scoring summary
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - scoring/summary.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`scoring/summary.json`'
      - file: 070_scoring_metrics.md
        section_heading: Threshold evaluation
        excerpt: metrics emitted in `scoring/summary.json`.
  - from: scoring
    to: reporting
    label: provide scoring outputs
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - scoring/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`scoring/**`, `criteria/**`, `detections/**`, manifest'
  - from: reporting
    to: baseline_library
    label: (optional regression) read baseline packages
    interaction: batch
    protocol: filesystem
    auth: unknown
    data:
      - exports/baselines/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 086_detection_baseline_library.md
        section_heading: Summary
        excerpt: stores baseline datasets for detections, scoring, and reporting.
  - from: reporting
    to: run_bundle_store
    label: (optional regression) materialize baseline inputs
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - inputs/baseline/**
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Canonical run sequence (v0.1)
        excerpt: '[reporting] (optional regression) materialize inputs/baseline/**'        
  - from: reporting
    to: report_artifacts
    label: publish report artifacts
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - report/report.json
      - report/thresholds.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: report/report.json and report/thresholds.json
      - file: 105_ci_operational_readiness.md
        section_heading: CI contract
        excerpt: '`runs/<run_id>/report/thresholds.json` and `runs/<run_id>/report/report.json` MUST be'
  - from: matrix_runner
    to: report_artifacts
    label: read report thresholds for CI gating
    interaction: batch
    protocol: filesystem
    auth: unknown
    data:
      - report/thresholds.json
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: CI contract
        excerpt: If `runs/<run_id>/report/thresholds.json` exists and validates against its schema.
  - from: signing
    to: integrity_artifacts
    label: publish checksums and signature
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - security/checksums.txt
      - security/signature.ed25519
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 020_architecture.md
        section_heading: Signing
        excerpt: produces integrity artifacts: `security/checksums.txt` and `security/signature.*`.
      - file: 120_config_reference.md
        section_heading: signing
        excerpt: 'algorithm: "ed25519"'
  - from: golden_dataset_builder
    to: golden_dataset_store
    label: publish golden dataset release
    interaction: file_drop
    protocol: filesystem
    auth: unknown
    data:
      - dataset_manifest.json
      - security/checksums.txt
    frequency: unknown
    reliability: unknown
    evidence:
      - file: 085_golden_datasets.md
        section_heading: Location
        excerpt: exports/datasets/<dataset_id>/<dataset_version>/
      - file: 085_golden_datasets.md
        section_heading: Integrity
        excerpt: Dataset releases MUST include `security/checksums.txt`.

workflows:
  - id: provisioning
    name: Provisioning and environment bring-up
    scope: provisioning
    steps:
      - n: 1
        from: operator
        to: orchestrator_cli
        message: invoke build/simulate to provision a run
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Overview
            excerpt: Operators and CI drive the orchestrator via a small set of verbs.
      - n: 2
        from: orchestrator_cli
        to: run_lock_dir
        message: acquire exclusive run lock
        data:
          - runs/.locks/<run_id>.lock
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Orchestrator (execution plane)
            excerpt: atomic creation of `runs/.locks/<run_id>.lock`.
      - n: 3
        from: orchestrator_cli
        to: run_bundle_store
        message: create runs/<run_id>/ and write initial manifest skeleton
        data:
          - runs/<run_id>/
          - runs/<run_id>/manifest.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: create runs/<run_id>/ (staging allowed)
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: write initial manifest.json skeleton
      - n: 4
        from: orchestrator_cli
        to: run_bundle_store
        message: materialize pinned operator inputs into inputs/
        data:
          - inputs/range.yaml
          - inputs/scenario.yaml
        evidence:
          - file: 020_architecture.md
            section_heading: Build-time input ingestion (normative, v0.1)
            excerpt: must materialize pinned inputs: `inputs/range.yaml` and `inputs/scenario.yaml`.
      - n: 5
        from: orchestrator_cli
        to: lab_provider
        message: execute lab_provider to snapshot lab inventory
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'build: Execute `lab_provider` stage only.'
      - n: 6
        from: lab_provider
        to: run_bundle_store
        message: publish deterministic inventory snapshot evidence
        data:
          - logs/lab_inventory_snapshot.json
        evidence:
          - file: ADR-0009-run-export-policy-and-log-classification.md
            section_heading: Deterministic evidence logs allowlist (normative)
            excerpt: logs/lab_inventory_snapshot.json
    evidence:
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: 'build: Execute `lab_provider` stage only.'
  - id: exercise_run
    name: Exercise run (happy path)
    scope: end_to_end
    steps:
      - n: 1
        from: operator
        to: orchestrator_cli
        message: invoke simulate (full pipeline)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: simulate: full pipeline (end-to-end).
      - n: 2
        from: orchestrator_cli
        to: run_lock_dir
        message: acquire exclusive run lock
        data:
          - runs/.locks/<run_id>.lock
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Orchestrator (execution plane)
            excerpt: atomic creation of `runs/.locks/<run_id>.lock`.
      - n: 3
        from: orchestrator_cli
        to: run_bundle_store
        message: write manifest skeleton and pin inputs into runs/<run_id>/inputs/
        data:
          - runs/<run_id>/manifest.json
          - inputs/range.yaml
          - inputs/scenario.yaml
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: write initial manifest.json skeleton
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: materialize/pin operator inputs into `runs/<run_id>/inputs/`
      - n: 4
        from: orchestrator_cli
        to: lab_provider
        message: run lab_provider and record stage outcome
        data:
          - logs/lab_inventory_snapshot.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[lab_provider] resolve inventory snapshot'
      - n: 5
        from: orchestrator_cli
        to: runner
        message: run runner to execute scenario actions
        data:
          - ground_truth.jsonl
          - runner/actions/<action_id>/**
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[runner] execute scenario actions -> write ground_truth.jsonl'
      - n: 6
        from: orchestrator_cli
        to: telemetry
        message: run telemetry to publish raw_parquet/** and telemetry validation
        data:
          - raw_parquet/**
          - logs/telemetry_validation.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish raw_parquet/** (and raw/** when enabled)
          - file: ADR-0009-run-export-policy-and-log-classification.md
            section_heading: Deterministic evidence logs allowlist (normative)
            excerpt: logs/telemetry_validation.json
      - n: 7
        from: orchestrator_cli
        to: normalization
        message: normalize raw_parquet/** into normalized/**
        data:
          - normalized/**
          - normalized/mapping_coverage.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[normalization] map raw_parquet/** -> publish normalized/**'
      - n: 8
        from: orchestrator_cli
        to: validation
        message: evaluate criteria and publish criteria/results.jsonl
        data:
          - criteria/results.jsonl
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish criteria/manifest.json + criteria/criteria.jsonl + criteria/results.jsonl
      - n: 9
        from: orchestrator_cli
        to: detection
        message: evaluate Sigma and publish detections/detections.jsonl
        data:
          - bridge/**
          - detections/detections.jsonl
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish bridge/** + detections/detections.jsonl
      - n: 10
        from: orchestrator_cli
        to: scoring
        message: compute scoring/summary.json
        data:
          - scoring/summary.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish scoring/summary.json
      - n: 11
        from: orchestrator_cli
        to: reporting
        message: generate report/report.json and report/thresholds.json
        data:
          - report/report.json
          - report/thresholds.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: report/report.json and report/thresholds.json
      - n: 12
        from: matrix_runner
        to: report_artifacts
        message: CI reads thresholds.json for pass/fail gating
        data:
          - report/thresholds.json
        evidence:
          - file: 105_ci_operational_readiness.md
            section_heading: CI contract
            excerpt: If `runs/<run_id>/report/thresholds.json` exists and validates against its schema.
      - n: 13
        from: orchestrator_cli
        to: signing
        message: (optional) sign run artifacts and publish security/**
        data:
          - security/checksums.txt
          - security/signature.ed25519
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[signing] (optional) sign artifacts -> publish security/**'
    evidence:
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: simulate: full pipeline (end-to-end).
  - id: scoring_reporting
    name: Telemetry ingest to scoring and reporting
    scope: analysis
    steps:
      - n: 1
        from: orchestrator_cli
        to: telemetry
        message: publish raw_parquet/** and telemetry validation evidence
        data:
          - raw_parquet/**
          - logs/telemetry_validation.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: '`raw_parquet/**`, `raw/**` (when raw preservation enabled)'
      - n: 2
        from: orchestrator_cli
        to: normalization
        message: map raw_parquet/** to normalized/** and mapping coverage
        data:
          - normalized/**
          - normalized/mapping_coverage.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: '`normalized/**`, `normalized/mapping_coverage.json`'
      - n: 3
        from: orchestrator_cli
        to: validation
        message: snapshot criteria pack and publish criteria results
        data:
          - criteria/manifest.json
          - criteria/results.jsonl
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: '`criteria/manifest.json`, `criteria/criteria.jsonl`, `criteria/results.jsonl`'
      - n: 4
        from: orchestrator_cli
        to: detection
        message: compile/evaluate Sigma and publish detections
        data:
          - bridge/**
          - detections/detections.jsonl
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: '`bridge/**`, `detections/detections.jsonl`'
      - n: 5
        from: orchestrator_cli
        to: scoring
        message: join ground truth, criteria, detections -> scoring summary
        data:
          - scoring/summary.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: '`scoring/summary.json`'
      - n: 6
        from: orchestrator_cli
        to: reporting
        message: generate report/report.json and report/thresholds.json
        data:
          - report/report.json
          - report/thresholds.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: report/report.json and report/thresholds.json
      - n: 7
        from: matrix_runner
        to: report_artifacts
        message: evaluate thresholds for CI verdict
        data:
          - report/thresholds.json
        evidence:
          - file: 105_ci_operational_readiness.md
            section_heading: CI contract
            excerpt: If `runs/<run_id>/report/thresholds.json` exists and validates against its schema.
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`raw_parquet/**`, mapping profiles'
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Minimum v0.1 IO boundaries (stage-local)
        excerpt: '`scoring/summary.json`'
      - file: 080_reporting.md
        section_heading: Reporting stage responsibilities
        excerpt: The reporting stage transforms scoring outputs into actionable artifacts.
  - id: teardown
    name: Runner teardown and cleanup evidence
    scope: runner
    steps:
      - n: 1
        from: runner
        to: run_bundle_store
        message: record per-action teardown phase outcome in ground_truth.jsonl
        data:
          - ground_truth.jsonl
        evidence:
          - file: ADR-0005-stage-outcomes-and-failure-classification.md
            section_heading: Runner stage
            excerpt: Ground truth MUST record lifecycle phase outcomes ... including a `teardown` phase.
      - n: 2
        from: runner
        to: run_bundle_store
        message: write per-action cleanup verification evidence (when enabled)
        data:
          - runner/actions/<action_id>/cleanup_verification.json
        evidence:
          - file: ADR-0005-stage-outcomes-and-failure-classification.md
            section_heading: Cleanup verification policy (normative)
            excerpt: write `runner/actions/<action_id>/cleanup_verification.json`.
      - n: 3
        from: runner
        to: run_bundle_store
        message: write state reconciliation report (when enabled)
        data:
          - runner/actions/<action_id>/state_reconciliation_report.json
        evidence:
          - file: ADR-0005-stage-outcomes-and-failure-classification.md
            section_heading: Runner stage
            excerpt: write `runner/actions/<action_id>/state_reconciliation_report.json`.
      - n: 4
        from: orchestrator_cli
        to: run_bundle_store
        message: record runner stage outcome in manifest and health log
        data:
          - runs/<run_id>/manifest.json
          - logs/health.json
        evidence:
          - file: ADR-0005-stage-outcomes-and-failure-classification.md
            section_heading: Decision
            excerpt: The orchestrator MUST record the stage outcome in runs/<run_id>/manifest.json.
      - n: 5
        from: orchestrator_cli
        to: run_bundle_store
        message: emit contract validation report on publish-gate failure
        data:
          - logs/contract_validation/<stage_id>.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Staging then atomic publish
            excerpt: 'emit a deterministic contract validation report at:'
      - n: 6
        from: orchestrator_cli
        to: run_bundle_store
        message: remove leftover .staging/<stage_id>/ directories during finalization
        data:
          - runs/<run_id>/.staging/<stage_id>/
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Staging then atomic publish
            excerpt: Implementations SHOULD remove any remaining stage staging directories.
    evidence:
      - file: ADR-0005-stage-outcomes-and-failure-classification.md
        section_heading: Cleanup verification policy (normative)
        excerpt: Ground truth MUST record lifecycle phase outcomes ... including a `teardown` phase.
  - id: run_replay
    name: Replay (analysis-only)
    scope: analysis
    steps:
      - n: 1
        from: operator
        to: orchestrator_cli
        message: invoke replay to rerun downstream analysis stages
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'replay: rerun only downstream analysis stages.'
      - n: 2
        from: orchestrator_cli
        to: normalization
        message: invoke normalization (replay)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'replay: rerun only downstream analysis stages.'
      - n: 3
        from: orchestrator_cli
        to: validation
        message: invoke validation (replay)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'replay: rerun only downstream analysis stages.'
      - n: 4
        from: orchestrator_cli
        to: detection
        message: invoke detection (replay)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'replay: rerun only downstream analysis stages.'
      - n: 5
        from: orchestrator_cli
        to: scoring
        message: invoke scoring (replay)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'replay: rerun only downstream analysis stages.'
      - n: 6
        from: orchestrator_cli
        to: reporting
        message: invoke reporting (replay)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'replay: rerun only downstream analysis stages.'
    evidence:
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: 'replay: rerun only downstream analysis stages.'
  - id: run_export
    name: Export (redaction-safe bundle)
    scope: export
    steps:
      - n: 1
        from: operator
        to: orchestrator_cli
        message: invoke export to package a run bundle for sharing
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'export: package a run bundle for sharing.'
      - n: 2
        from: orchestrator_cli
        to: audit_redactor
        message: redact operator-facing export
        data: []
        evidence:
          - file: ADR-0003-redaction-policy.md
            section_heading: Decision
            excerpt: All operator-facing exports MUST run through the redaction pipeline.
          - file: ADR-0009-run-export-policy-and-log-classification.md
            section_heading: Policy
            excerpt: Exports MUST exclude `unredacted/**` by default.
    evidence:
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: 'export: package a run bundle for sharing.'
  - id: range_destroy
    name: Destroy (range teardown)
    scope: provisioning
    steps:
      - n: 1
        from: operator
        to: orchestrator_cli
        message: invoke destroy to tear down range resources
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: 'destroy: tear down range resources.'
    evidence:
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: 'destroy: tear down range resources.'
  - id: publish_gate
    name: Publish gate (staging + atomic publish)
    scope: control_plane
    steps:
      - n: 1
        from: orchestrator_cli
        to: staging_area
        message: write stage outputs under .staging/ prior to publish
        data: []
        evidence:
          - file: 000_charter.md
            section_heading: Guiding principles
            excerpt: Stages write to a staging location (`.staging/`).
      - n: 2
        from: orchestrator_cli
        to: run_bundle_store
        message: validate required schema contracts before publish
        data: []
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Staging then atomic publish
            excerpt: validate all required schema contracts before publish
      - n: 3
        from: orchestrator_cli
        to: run_bundle_store
        message: publish via atomic rename into final run-bundle paths
        data: []
        evidence:
          - file: 000_charter.md
            section_heading: Guiding principles
            excerpt: publish them by atomic rename after validation.
          - file: 015_lab_providers.md
            section_heading: Publish and validation gate
            excerpt: The stage MUST publish by atomic rename into the final run bundle location.
    evidence:
      - file: glossary.yaml
        section_heading: publish_gate
        excerpt: Write to a staging location first, validate, then publish atomically.

states: []

requirements:
  - id: deterministic_run_bundles
    description: Run bundles must be deterministic and contract-backed.
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: File-based stage coordination (normative)
        excerpt: Stages MUST communicate by reading and writing contract-backed artifacts.
  - id: schema_validation
    description: All stage outputs must validate against schemas before publish.
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Staging then atomic publish
        excerpt: validate all required schema contracts before publish
  - id: ci_gating
    description: CI verdict must be derived from thresholds.json when present and valid.
    evidence:
      - file: 105_ci_operational_readiness.md
        section_heading: CI contract
        excerpt: If `runs/<run_id>/report/thresholds.json` exists and validates against its schema.

constraints:
  - id: no_inferred_integrations
    description: Do not infer technologies or integrations not explicitly stated.
    evidence:
      - file: 010_scope.md
        section_heading: Non-goals
        excerpt: Do not assume specific vendor stacks unless explicitly required.
  - id: one_shot_local_first
    description: System runs as a one-shot, local-first pipeline.
    evidence:
      - file: 020_architecture.md
        section_heading: Overview
        excerpt: Purple Axiom is a one-shot, local-first pipeline.
  - id: single_host_no_internal_rpc
    description: Executed on a single host without internal service-to-service RPC.
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Decision
        excerpt: executed on a single host without internal service-to-service RPC.
  - id: filesystem_contract_boundary
    description: Run bundle directory is the contract boundary between stages.
    evidence:
      - file: 020_architecture.md
        section_heading: Workspace boundary (local-first)
        excerpt: filesystem contract boundary between stages.
  - id: publish_gate_atomic_publish
    description: Artifacts are staged, validated, and published via atomic rename.
    evidence:
      - file: 000_charter.md
        section_heading: Guiding principles
        excerpt: publish them by atomic rename after validation.
      - file: 015_lab_providers.md
        section_heading: Publish and validation gate
        excerpt: The stage MUST publish by atomic rename into the final run bundle location.
  - id: redaction_safe_by_default
    description: Unredacted artifacts are quarantined and excluded from exports by default.
    evidence:
      - file: 090_security_safety.md
        section_heading: Redaction and quarantine
        excerpt: "Quarantine location: `runs/<run_id>/unredacted/` (default)."
      - file: ADR-0009-run-export-policy-and-log-classification.md
        section_heading: Policy
        excerpt: Exports MUST exclude `unredacted/**` by default.

glossary:
  - term: run bundle
    definition: Filesystem directory containing all artifacts for a run under runs/<run_id>/.
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: Run bundle (coordination and evidence plane)
        excerpt: Run bundle (`runs/<run_id>/`) is the authoritative coordination substrate.
  - term: stage
    definition: A pipeline unit that reads inputs from the run bundle and writes outputs back.
    evidence:
      - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
        section_heading: File-based stage coordination (normative)
        excerpt: Stages MUST communicate by reading and writing contract-backed artifacts.
  - term: publish gate
    definition: Write to staging, validate, then publish atomically into final locations.
    evidence:
      - file: glossary.yaml
        section_heading: publish_gate
        excerpt: Write to a staging location first, validate, then publish atomically.
  - term: baseline library
    definition: Set of BDPs under exports/baselines managed via the Operator Interface.
    evidence:
      - file: glossary.yaml
        section_heading: baseline_library
        excerpt: managed via the Operator Interface.
notes:
  open_questions:
    - id: orchestrator_implementation_tech
      question: What runtime language/framework is used for the orchestrator monolith?
      impact: Affects deployment diagram and relationship protocols/auth details.
      evidence:
        - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
          section_heading: Orchestrator (execution plane)
          excerpt: SHOULD execute the core pipeline stages in a single process for v0.1.
    - id: criteria_engine_implementation
      question: What engine executes validation criteria (custom DSL vs embedded runtime)?
      impact: Affects validation stage container internals and dependency edges.
      evidence:
        - file: 035_validation_criteria.md
          section_heading: Execution model
          excerpt: Criteria execution engine details are intentionally abstracted.
    - id: operator_interface_authn_authz
      question: What authentication/authorization applies to the operator interface endpoints?
      impact: Affects trust boundaries and auth fields on operator interface relationships.
      evidence:
        - file: 115_operator_interface.md
          section_heading: Security
          excerpt: Authentication and authorization model TBD.
    - id: golden_dataset_builder_tooling
      question: What tool or process generates golden datasets and when in CI?
      impact: Affects workflows for dataset release and regression.
      evidence:
        - file: 085_golden_datasets.md
          section_heading: Generation
          excerpt: Dataset build process is implementation-defined.
    - id: baseline_package_generation_flow
      question: How are baseline packages created and versioned for reporting regression?
      impact: Affects reporting workflow steps and baseline library relationships.
      evidence:
        - file: 086_detection_baseline_library.md
          section_heading: Baseline package generation
          excerpt: Baseline package generation flow is not specified.
    - id: export_bundle_format_and_transport
      question: What is the export bundle format and how is it transported out of CI?
      impact: Affects external integrations and reporting artifact distribution.
      evidence:
        - file: ADR-0009-run-export-policy-and-log-classification.md
          section_heading: Run export policy (normative)
          excerpt: Export bundle transport is out of scope for v0.1.
    - id: threat_intel_pack_consumers
      question: Which stages consume threat_intel_packs and how represented in workflows?
      impact: Affects additional edges and workflow steps for enrichment.
      evidence:
        - file: ADR-0008-Threat-intelligence-integration-model.md
          section_heading: Interaction with run-bundle snapshots
          excerpt: The owning stage MUST materialize them.
  security_findings: []
