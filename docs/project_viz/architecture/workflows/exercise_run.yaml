# file: docs/project_viz/architecture/workflows/exercise_run.yaml
workflows:
  - id: exercise_run
    name: Exercise run (happy path)
    scope: end_to_end
    steps:
      - n: 1
        from: operator
        to: orchestrator_cli
        message: invoke simulate (full pipeline)
        data: []
        evidence:
          - file: 020_architecture.md
            section_heading: Range lifecycle verbs
            excerpt: "simulate: full pipeline (end-to-end)."
      - n: 2
        from: orchestrator_cli
        to: run_lock_dir
        message: acquire exclusive run lock
        data:
          - runs/.locks/<run_id>.lock
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Orchestrator (execution plane)
            excerpt: atomic creation of `runs/.locks/<run_id>.lock`.
      - n: 3
        from: orchestrator_cli
        to: run_bundle_store
        message: write manifest skeleton and pin inputs into runs/<run_id>/inputs/
        data:
          - manifest.json
          - inputs/range.yaml
          - inputs/scenario.yaml
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: write initial manifest.json skeleton
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: materialize/pin operator inputs into `runs/<run_id>/inputs/`
      - n: 4
        from: orchestrator_cli
        to: lab_provider
        message: run lab_provider and record stage outcome
        data:
          - logs/lab_inventory_snapshot.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[lab_provider] resolve inventory snapshot'
      - n: 5
        from: orchestrator_cli
        to: runner
        message: (optional) run environment configuration and record `runner.environment_config` substage outcome
        data:
          - manifest.json
          - logs/health.json
        evidence:
          - file: 020_architecture.md
            section_heading: Stage execution order
            excerpt: "MUST record an additive `runner` substage `runner.environment_config` after `lab_provider` completes and before any action enters the runner `prepare` lifecycle phase."
          - file: 020_architecture.md
            section_heading: Stage execution order
            excerpt: "This substage MUST be observable via stage outcomes in `manifest.json` and, when health files are enabled, via `logs/health.json`."
          - file: 120_config_reference.md
            section_heading: Runner (runner)
            excerpt: "When `environment_config.mode != off`, the orchestrator records the substage outcome as `runner.environment_config` and emits deterministic evidence under `runs/<run_id>/logs/**`"
      - n: 6
        from: orchestrator_cli
        to: runner        
        message: run runner to execute scenario actions
        data:
          - ground_truth.jsonl
          - runner/actions/<action_id>/**
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[runner] execute scenario actions -> write ground_truth.jsonl'
      - n: 7
        from: orchestrator_cli
        to: telemetry
        message: run telemetry post-run harvest/validation/publish to materialize raw_parquet/** (and raw/** when enabled)
        data:
          - raw_parquet/**
          - raw/**
          - logs/telemetry_validation.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish raw_parquet/** (and raw/** when enabled)
          - file: 020_architecture.md
            section_heading: Stage execution order
            excerpt: "The `telemetry` stage boundary refers to the post-run harvest/validation/publish step that materializes `raw_parquet/**` for downstream stages."            
          - file: ADR-0009-run-export-policy-and-log-classification.md
            section_heading: Deterministic evidence logs allowlist (normative)
            excerpt: logs/telemetry_validation.json
      - n: 8
        from: orchestrator_cli
        to: normalization
        message: normalize raw_parquet/** into normalized/** and publish mapping coverage + profile snapshot
        data:
          - normalized/**
          - normalized/mapping_coverage.json
          - normalized/mapping_profile_snapshot.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[normalization] map raw_parquet/** -> publish normalized/**'
      - n: 9
        from: orchestrator_cli
        to: validation
        message: evaluate criteria and publish criteria/manifest.json + criteria/criteria.jsonl + criteria/results.jsonl
        data:
          - criteria/manifest.json
          - criteria/criteria.jsonl        
          - criteria/results.jsonl
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish criteria/manifest.json + criteria/criteria.jsonl + criteria/results.jsonl
      - n: 10
        from: orchestrator_cli
        to: detection
        message: evaluate Sigma and publish detections/detections.jsonl
        data:
          - bridge/**
          - detections/detections.jsonl
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish bridge/** + detections/detections.jsonl
      - n: 11
        from: orchestrator_cli
        to: scoring
        message: compute scoring/summary.json
        data:
          - scoring/summary.json
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: publish scoring/summary.json
      - n: 12
        from: orchestrator_cli
        to: reporting
        message: generate report/report.json, report/thresholds.json, and report/run_timeline.md
        data:
          - report/report.json
          - report/thresholds.json
          - report/run_timeline.md
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Minimum v0.1 IO boundaries (stage-local)
            excerpt: report/report.json and report/thresholds.json
          - file: 080_reporting.md
            section_heading: Required reporting outputs (v0.1)
            excerpt: "`report/run_timeline.md` | Deterministic, human-readable run timeline in UTC (operator UI + exports)"            
      - n: 13
        from: orchestrator_cli
        to: signing
        message: (optional) sign run artifacts and publish security/**
        data:
          - security/checksums.txt
          - security/signature.ed25519
          - security/public_key.ed25519
        evidence:
          - file: ADR-0004-deployment-architecture-and-inter-component-communication.md
            section_heading: Canonical run sequence (v0.1)
            excerpt: '[signing] (optional) sign artifacts -> publish security/**'
    evidence:
      - file: 020_architecture.md
        section_heading: Range lifecycle verbs
        excerpt: "simulate: full pipeline (end-to-end)."
