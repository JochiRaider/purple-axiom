{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "docs/contracts/lab_inventory_snapshot.schema.json",
  "title": "Lab inventory snapshot",
  "description": "Schema for the deterministic lab inventory snapshot artifact (runs/<run_id>/logs/lab_inventory_snapshot.json).",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "v",
    "assets"
  ],
  "properties": {
    "contract_version": {
      "type": "string",
      "const": "0.1.0",
      "description": "Contract schema version constant. Optional for this artifact; when present it MUST match the registry-declared contract_version for the bound contract_id."
    },
    "v": {
      "type": "integer",
      "const": 1,
      "description": "Inventory snapshot schema version."
    },
    "assets": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/asset"
      },
      "description": "Resolved lab assets in canonical form."
    },
    "placeholder": {
      "$ref": "#/$defs/pa_placeholder_v1"
    }
  },
  "$comment": "See 015_lab_providers.md for deterministic ordering, canonical JSON serialization (RFC 8785 / JCS), and invariant checks that are not expressible in JSON Schema (e.g., assets[] sorted by asset_id).",
  "$defs": {
    "id_slug_v1": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^[a-z0-9](?:[a-z0-9-]{0,62}[a-z0-9])?$",
      "not": {
        "pattern": "--"
      },
      "description": "Lowercase ASCII identifier (id_slug_v1)."
    },
    "os": {
      "type": "string",
      "enum": [
        "windows",
        "linux",
        "macos",
        "bsd",
        "appliance",
        "other"
      ],
      "description": "Operating system family."
    },
    "role": {
      "type": "string",
      "enum": [
        "endpoint",
        "server",
        "domain_controller",
        "network",
        "sensor",
        "other"
      ],
      "description": "Optional asset role hint."
    },
    "tag": {
      "type": "string",
      "minLength": 1,
      "pattern": "^(?:\\S|\\S.*\\S)$",
      "description": "Non-empty tag string without leading/trailing whitespace."
    },
    "ip_literal": {
      "type": "string",
      "anyOf": [
        {
          "pattern": "^(?:0|[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-5])(?:\\.(?:0|[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-5])){3}$",
          "description": "IPv4 dotted-decimal without leading zeros."
        },
        {
          "pattern": "^(?:(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){7}(?:0|[1-9a-f][0-9a-f]{0,3})|(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){1,7}:|(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){1,6}:(?:0|[1-9a-f][0-9a-f]{0,3})|(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){1,5}(?::(?:0|[1-9a-f][0-9a-f]{0,3})){1,2}|(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){1,4}(?::(?:0|[1-9a-f][0-9a-f]{0,3})){1,3}|(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){1,3}(?::(?:0|[1-9a-f][0-9a-f]{0,3})){1,4}|(?:(?:0|[1-9a-f][0-9a-f]{0,3}):){1,2}(?::(?:0|[1-9a-f][0-9a-f]{0,3})){1,5}|(?:0|[1-9a-f][0-9a-f]{0,3}):(?:(?::(?:0|[1-9a-f][0-9a-f]{0,3})){1,6})|:(?:(?::(?:0|[1-9a-f][0-9a-f]{0,3})){1,7}|:))$",
          "description": "IPv6 literal with lowercase hex. Canonical RFC5952 compression rules are enforced by publish-gate invariants (out of scope for JSON Schema)."
        }
      ],
      "description": "Management IP address literal (no port, no brackets, no zone identifier)."
    },
    "connection_vars": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ansible_host": {
          "type": "string",
          "minLength": 1
        },
        "ansible_port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        },
        "ansible_connection": {
          "type": "string",
          "minLength": 1
        },
        "ansible_user": {
          "type": "string",
          "minLength": 1
        },
        "ansible_shell_type": {
          "type": "string",
          "minLength": 1
        }
      },
      "description": "Allowlisted, non-secret connection hints."
    },
    "asset": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "asset_id": {
          "$ref": "#/$defs/id_slug_v1"
        },
        "os": {
          "$ref": "#/$defs/os"
        },
        "role": {
          "$ref": "#/$defs/role"
        },
        "hostname": {
          "type": "string",
          "minLength": 1
        },
        "ip": {
          "$ref": "#/$defs/ip_literal"
        },
        "tags": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/tag"
          },
          "uniqueItems": true
        },
        "vars": {
          "$ref": "#/$defs/connection_vars"
        },
        "provider_asset_ref": {
          "type": "string",
          "minLength": 1
        }
      },
      "required": [
        "asset_id",
        "os"
      ],
      "description": "Canonical asset descriptor."
    },
    "pa_placeholder_v1": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "placeholder_version",
        "handling",
        "reason_code",
        "reason_domain"
      ],
      "properties": {
        "placeholder_version": {
          "type": "string",
          "const": "pa.placeholder.v1"
        },
        "handling": {
          "type": "string",
          "enum": [
            "withheld",
            "quarantined",
            "absent"
          ]
        },
        "reason_code": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "reason_domain": {
          "type": "string",
          "const": "artifact_placeholder"
        },
        "sha256": {
          "type": "string",
          "pattern": "^sha256:[0-9a-f]{64}$"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "handling": {
                "const": "absent"
              }
            },
            "required": [
              "handling"
            ]
          },
          "then": {
            "properties": {
              "sha256": false
            }
          }
        }
      ]
    }
  }
}
