# mappings/normalizer/ocsf/1.7.0/linux-auditd/classes/file_system_activity_1001.yaml
format_version: 1

class_map:
  class_uid: 1001
  class_name: File System Activity
  category_uid: 1

  # Routing key is syscall number (as string).
  # Activity mapping based on syscall semantics.
  event_id_map:
    # Open/Create family
    "2": {activity_id: 2, activity_name: "Read"}        # open (may be read or write; default to read)
    "257": {activity_id: 2, activity_name: "Read"}      # openat (may be read or write; default to read)
    "85": {activity_id: 1, activity_name: "Create"}     # creat

    # Delete family
    "87": {activity_id: 4, activity_name: "Delete"}     # unlink
    "263": {activity_id: 4, activity_name: "Delete"}    # unlinkat

    # Rename family
    "82": {activity_id: 5, activity_name: "Rename"}     # rename
    "264": {activity_id: 5, activity_name: "Rename"}    # renameat

    # Permission change family
    "90": {activity_id: 7, activity_name: "Set Security"}   # chmod
    "268": {activity_id: 7, activity_name: "Set Security"}  # fchmodat
    "92": {activity_id: 7, activity_name: "Set Security"}   # chown
    "260": {activity_id: 7, activity_name: "Set Security"}  # fchownat

emit:
  # --- Classification ---
  class_uid:
    const_from_class: true

  category_uid:
    const_from_class: true

  activity_id:
    from_event_id_map: activity_id

  type_uid:
    op: compute_type_uid
    args:
      class_uid_from_class: true
      activity_id_from_event_id_map: true

  status_id:
    from: fields.success
    transforms: [trim_ascii, map_success_to_status_id]

  # --- File ---
  # The primary file target comes from PATH records (aggregated into fields.path or fields.name).
  # If path is relative, combine with cwd.
  file.path:
    from: fields.name
    transforms: [trim_ascii, absent_if_placeholder, decode_hex_if_encoded, resolve_path_with_cwd]

  file.name:
    from: fields.name
    transforms: [trim_ascii, absent_if_placeholder, decode_hex_if_encoded, extract_basename]

  file.parent_folder:
    from: fields.name
    transforms: [trim_ascii, absent_if_placeholder, decode_hex_if_encoded, resolve_path_with_cwd, extract_parent_folder]

  # --- Actor Process ---
  actor.process.pid:
    from: fields.pid
    transforms: [trim_ascii, parse_int]

  actor.process.file.path:
    from: fields.exe
    transforms: [trim_ascii, absent_if_placeholder]

  actor.process.name:
    from: fields.exe
    transforms: [trim_ascii, absent_if_placeholder, extract_basename]

  actor.process.cmd_line:
    from: fields.proctitle
    transforms: [trim_ascii, absent_if_placeholder, decode_hex_proctitle]

  # --- Actor User ---
  actor.user.uid:
    from: fields.auid
    transforms: [trim_ascii, absent_if_placeholder, absent_if_unset_uid, to_string]
    fallback:
      from: fields.uid
      transforms: [trim_ascii, absent_if_placeholder, absent_if_unset_uid, to_string]

  # --- Unmapped auditd-specific fields ---
  unmapped.auditd.nametype:
    from: fields.nametype
    transforms: [trim_ascii, absent_if_placeholder]

  unmapped.auditd.objtype:
    from: fields.objtype
    transforms: [trim_ascii, absent_if_placeholder]

  unmapped.auditd.cwd:
    from: fields.cwd
    transforms: [trim_ascii, absent_if_placeholder, decode_hex_if_encoded]

  unmapped.auditd.inode:
    from: fields.inode
    transforms: [trim_ascii, absent_if_placeholder]

  unmapped.auditd.mode:
    from: fields.mode
    transforms: [trim_ascii, absent_if_placeholder]

  unmapped.auditd.ouid:
    from: fields.ouid
    transforms: [trim_ascii, absent_if_placeholder]

  unmapped.auditd.ogid:
    from: fields.ogid
    transforms: [trim_ascii, absent_if_placeholder]

no_inference:
  forbidden_derivations:
    - file.hash_from_path
    - file.owner_from_ouid_lookup
    - actor.user.name_from_uid_lookup
    # Note: activity_id for open/openat defaults to Read; actual intent
    # (read vs write) would require flag inspection which is not implemented.
    - activity_id_from_open_flags